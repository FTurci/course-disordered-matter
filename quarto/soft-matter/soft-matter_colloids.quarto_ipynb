{
  "cells": [
    {
      "cell_type": "markdown",
      "metadata": {},
      "source": [
        "---\n",
        "format: live-html\n",
        "title: \"Colloids\"\n",
        "pyodide:\n",
        "    packages:\n",
        "        - numpy\n",
        "        - matplotlib\n",
        "        - plotly\n",
        "        - nbformat\n",
        "resources:\n",
        "    - src/plotting.py\n",
        "    - src/hardspheres.py\n",
        "bibliography: references.bib\n",
        "\n",
        "toc-depth: 4\n",
        "---\n",
        "\n",
        "```{pyodide}\n",
        "#| echo: false\n",
        "#| autorun: true\n",
        "# modifying the path to add the code folder\n",
        "import sys\n",
        "sys.path.insert(0, 'src')\n",
        "```\n",
        "\n",
        "## Kinds of colloids\n",
        "\n",
        "Colloids are mixtures where one substance is dispersed throughout another. They consist of particles that are larger than typical molecules but small enough to remain suspended without settling. Examples include milk, fog, and paint.\n",
        "\n",
        "Colloids can be classified based on the state of the **dispersed phase** and the **dispersion medium**. Depending on the particular mixture, one can obtain a wide variety of soft materials, with unique mechanical, optical, and thermal properties.\n",
        "\n",
        "+------------------+----------------------------------+-------------------------------+\n",
        "| Dispersion Phase |                                  | Dispersion Medium             |\n",
        "+==================+==================================+===============================+\n",
        "|                  | Solid                            | Liquid                        |\n",
        "+------------------+----------------------------------+-------------------------------+\n",
        "| Solid            | *Solid suspension:*\\             | *Sol, colloidal suspension:*\\ |\n",
        "|                  | pigmented plastics,\\             | metal sol,\\                   |\n",
        "|                  | stained glass,\\                  | toothpaste, paint,\\           |\n",
        "|                  | ruby glass, opal, pearl          | ink, clay slurries, mud       |\n",
        "+------------------+----------------------------------+-------------------------------+\n",
        "| Liquid           | *Solid emulsion:*\\               | *Emulsion:*\\                  |\n",
        "|                  | bituminous road paving,\\         | milk, mayonnaise,\\            |\n",
        "|                  | ice cream                        | butter, pharmaceutical creams |\n",
        "+------------------+----------------------------------+-------------------------------+\n",
        "| Gas              | *Solid foam:*\\                   | *Foam:*\\                      |\n",
        "|                  | zeolites, expanded polystyrene,\\ | froths, soap foam,\\           |\n",
        "|                  | ‘silica gel’                     | fire-extinguisher foam        |\n",
        "+------------------+----------------------------------+-------------------------------+\n",
        "\n",
        "Clearly, colloidal materials form an incredibly diverse class, and surround us in our everyday lives. Here are some visual examples from the table above:\n",
        "\n",
        "![First row: opal, paint, smoke. Middle row: ice-cream (*gelato*), milk, fog. Bottom row: expanded polystyrene and foam. Source: unsplash.com](figs/colloids.png)\n",
        "\n",
        "The [IUPAC definition of colloids](https://goldbook.iupac.org/terms/view/C01172) is based on the idea that the particles are dispersed in a medium, creating a *subdivision* at the **colloidal scale**: approximately 1nm to 1µm.\n",
        "\n",
        "The small sizes of colloids means that they are constantly subject to the collisions with the atom/molecules/particle of the medium, triggered by thermal fluctuations. Due to this, the colloids undergo [Brownian motion](../phase-transitions/Brownian-and-Langevin-dynamics.qmd). For each particle, the amount of energy received from the medium is of the order of $k_B T$ (the reference energy scale of thermal soft matter). This energy can be compared with the the potential energy to produce a dimensionless number, the **gravitational Péclet number**\n",
        "\n",
        "$${\\rm Pe}_g = \\dfrac{\\Delta m g R}{k_B T}$$\n",
        "\n",
        "where $R$ is the radius of the colloid respectively, $g$ is the acceleration due to gravity, and $\\Delta m$ is the *buoyant mass*, which for a spherical colloid is expressed as $\\Delta m = \\dfrac{4\\pi}{3}\\Delta\\rho R^3$, with $\\Delta \\rho$ being the density difference between the particle and the dispersion medium (the *solvent*). We have a colloidal suspension only when ${\\rm Pe}_g \\lesssim 1$, i.e. when Brownian motion is only marginally perturbed by the effects of gravity.\n",
        "\n",
        "## Stability of colloids and colloid-colloid interactions\n",
        "\n",
        "A colloidal dispersion is said to be **stable** if it is able to remain dispersed and Brownian for a long time (typically, significantly longer than the experimental observation time). Unstable colloids undergo aggregation or sedimentation due to the dominance of attractive forces or gravity.\n",
        "\n",
        "For example, consider a colloidal suspension like milk. Milk is an emulsion where fat droplets are dispersed in water and stabilised by proteins. If lemon juice (an acid) is added, the dispersion medium (water) changes, the pH drops, and the emulsion is *destabilised*. This causes the proteins to coagulate, leading to the separation of curds (solid) and whey (liquid).\n",
        "\n",
        "![Curds and whey resulting from the destabilisation of milk, a colloidal emulsion. (Wikimedia)](figs/Curds_and_whey.jpg)\n",
        "\n",
        "It is clear from this example that the nature of the dispersed phase and the dispersed medium ultimately determine the stability of colloidal dispersions. What ultimately matters for the stability is whether the colloids have a propensity to aggregate or not. This propensity is quantified in terms of **colloidal interactions**.\n",
        "\n",
        "### Fundamental and effective forces\n",
        "\n",
        "At the colloidal scales, only two kinds of fundamental forces are relevant: gravity and electro (and occasionally magneto) static forces. As we have seen above, when a system is truly colloidal, gravitational contributions are assumed to be small, so in effect for a non magnetic colloid (which is the vast majority of colloidal systems) only electrostatic forces are fundamentally important.\n",
        "\n",
        "However, colloidal dispersions consist of large particles carrying many charges both in the dispersed phase and the surrounding medium, arranged disorderly at the atomic scale. This makes a microscopic description of all charges and the resulting electrostatic fields not only unfeasible but also ineffective for understanding colloidal systems in terms of key characteristics such as particle size, density, and spatial distribution. The fundamental issue is the one of time-scales: the motion of colloids is much slower than the motion of individual ions or molecules. Over such longer timescales, many interactions at the **microscopic** atomistic scale take place and we can think of taking averages to extract **macroscopic**, **effective** interactions at the colloidal scale [^soft-matter_colloids-1].\n",
        "\n",
        "[^soft-matter_colloids-1]: This is clearly an instance of the idea of **coarse graining** that we have introduced [earlier](soft-matter_intro.qmd).\n",
        "\n",
        "This is especially important due to **quantum fluctuations**: the uncertainty principle means that electron clouds around atoms are not fixed but exhibit intrinsic fluctuations in their charge distribution. Perturbative approaches allow us to capture the effective forces resulting from such fluctuations.\n",
        "\n",
        "There are many examples of such effective forces [@lekkerkerker2024colloids]. One you may already know is the Van der Waals interaction. For colloids, we have additional relevant forces, such as the double layer interaction and the depletion interaction. We detail them here below.\n",
        "\n",
        "### Van der Waals interaction\n",
        "\n",
        "The London-van der Waals **dispersion forces** arise from the interaction between **instantaneous dipoles** in overall neutral atoms or molecules. We know from classical electrostatics that static dipoles interact via the dipole-dipole interaction, with a potential strength which decays like $1/r^3$, where $r$ is the separation between two dipoles.\n",
        "\n",
        "More in general, neutral atom or molecules have electronic clouds that are fluctuating and not symmetrically distributed, creating a **temporary dipole**. Such instantaneous dipole **induces** a dipole in a neighboring atom or molecule by distorting its electron cloud.\n",
        "\n",
        "The interaction energy between two dipoles $\\mu_1$ and $\\mu_2$ separated by a distance $r$ is proportional to: $$\n",
        "U \\propto -\\frac{\\mu_1 \\mu_2}{r^3}\n",
        "$$\n",
        "\n",
        "::: column-margin\n",
        "::: {.content-visible when-format=\"live-html\"}\n",
        "![Johannes Diderik van der Waals (1837-1923), who hypothesised the existence of forces responsible for the non-ideal behaviour of gases.](figs/Johannes_Diderik_van_der_Waals.jpg){width=\"150\" fig-align=\"left\"}\n",
        "\n",
        "![Left: Hugo C. Hamaker (1905-1993), who explained the origin of Van der Waals forces, and Fritz London (1900-1954), who quantified the dispersion force.](figs/hamaker-london.png){width=\"300\" fig-align=\"left\"}\n",
        ":::\n",
        ":::\n",
        "\n",
        "The dipole moments fluctuate due to quantum mechanical effects. The average interaction energy is derived using perturbation theory and is proportional to the polarisabilities $\\alpha_1$ and $\\alpha_2$ of the two particles:\n",
        "\n",
        "::: {style=\"border: 2px solid red; padding: 1em; border-radius: 8px; background-color: transparent;\"}\n",
        "$$\n",
        "    U(r) = -\\frac{C}{r^6}\n",
        "$$\n",
        ":::\n",
        "\n",
        "where $C \\propto \\alpha_1 \\alpha_2$ depends on the polarisabilities and ionization energies of the particles.\n",
        "\n",
        "The resulting $r^{-6}$ dependence is also referred to as the **London dispersion force**, which can be derived within quantum-mechanical perturbation theory [@london1937general].\n",
        "\n",
        "We can then assume to take two identical spherical colloids of radius $R$ at distance $h$ and that every volume element of such spheres interacts with the London dispersion force (see the semi-classical approach of Hamaker @hamaker1937london for illustration). Integrating over all volume elements yields the collodial spheres **Van der Waals attractive potential** in the form\n",
        "\n",
        "::: {style=\"border: 2px solid red; padding: 1em; border-radius: 8px; background-color: transparent;\"}\n",
        "$$W_{wdW}(h)=-\\dfrac{A-H}{g}f(h/R)$$\n",
        ":::\n",
        "\n",
        "where $A_H$ is the **Hamaker constant** and $f(h/R)$ is\n",
        "\n",
        "$$f(h/R) = \\left[ \\frac{2R^2}{h^2 - 4R^2} + \\frac{2R^2}{h^2} + \\ln\\left( \\frac{h^2 - 4R^2}{h^2} \\right) \\right]$$\n",
        "\n",
        "::: {.callout-note collapse=\"true\"}\n",
        "# Sketch of a derivation of colloid-colloid Van der Waals potential\n",
        "\n",
        "Each volume element in one sphere interacts with each in the other sphere via:\n",
        "\n",
        "$$\n",
        "\\phi(r) = -\\frac{C}{r^6}\n",
        "$$\n",
        "\n",
        "So the total interaction energy is:\n",
        "\n",
        "$$\n",
        "U(h) = -C \\iint \\frac{1}{|\\mathbf{r}_1 - \\mathbf{r}_2|^6} \\, dV_1 \\, dV_2\n",
        "$$\n",
        "\n",
        "Let:\n",
        "\n",
        "-   Sphere 1 be centered at $(0, 0, 0)$,\n",
        "-   Sphere 2 be centered at $(0, 0, h)$,\n",
        "-   $\\mathbf{r}_1 = \\mathbf{r}$, $\\mathbf{r}_2 = \\mathbf{r}'$\n",
        "\n",
        "Then $|\\mathbf{r}_1 - \\mathbf{r}_2| = |\\mathbf{r} - \\mathbf{r}'|$, and the integral becomes:\n",
        "\n",
        "$$\n",
        "U(h) = -C \\iiint_{|\\mathbf{r}| \\leq R} \\iiint_{|\\mathbf{r}' - h\\hat{z}| \\leq R} \\frac{1}{|\\mathbf{r} - \\mathbf{r}'|^6} \\, d^3\\mathbf{r} \\, d^3\\mathbf{r}'\n",
        "$$\n",
        "\n",
        "Hamaker evaluated this by integrating over the **densities of interacting atoms** with number density $\\rho$ in both spheres. The result:\n",
        "\n",
        "$$\n",
        "U(h) = -\\rho^2 C \\iint \\frac{1}{|\\mathbf{r}_1 - \\mathbf{r}_2|^6} \\, dV_1 \\, dV_2\n",
        "$$\n",
        "\n",
        "Defining the **Hamaker constant**:\n",
        "\n",
        "$$\n",
        "A_H = \\pi^2 \\rho^2 C\n",
        "$$\n",
        "\n",
        "So,\n",
        "\n",
        "$$\n",
        "U(h) = -\\frac{A_H}{\\pi^2} \\iint \\frac{1}{|\\mathbf{r}_1 - \\mathbf{r}_2|^6} \\, dV_1 \\, dV_2\n",
        "$$\n",
        "\n",
        "This six-dimensional integral can be evaluated analytically for spheres, yielding:\n",
        "\n",
        "$$\n",
        "U(h) = -\\frac{A_H}{6} \\left[ \\frac{2R^2}{h^2 - 4R^2} + \\frac{2R^2}{h^2} + \\ln\\left( \\frac{h^2 - 4R^2}{h^2} \\right) \\right]\n",
        "$$\n",
        ":::\n",
        "\n",
        "```{pyodide}\n",
        "#| autorun: true\n",
        "import numpy as np\n",
        "import plotting\n",
        "# parameters: change them to explore the interaction!\n",
        "R = 5.0  # Radius of the colloid\n",
        "A_H = 1e-20  # Hamaker constant (in Joules)\n",
        "h = np.linspace(2.01 * R, 10+R*2, 1000)  # Separation distance (h > 2R)\n",
        "# Van der Waals potential\n",
        "def van_der_waals_potential(h, R, A_H):\n",
        "    f_h_R = (2 * R**2 / (h**2 - 4 * R**2)) + (2 * R**2 / h**2) + np.log((h**2 - 4 * R**2) / h**2)\n",
        "    return -A_H * f_h_R\n",
        "\n",
        "# compute potential\n",
        "W_vdW = van_der_waals_potential(h, R, A_H)\n",
        "# convenience plotting function, you can use matplotlib if you prefer\n",
        "plotting.simple_plot(h,W_vdW)\n",
        "```\n",
        "\n",
        "Van der Waals interactions are considered to be **short-range** forces in the sense that their decay rate(e.g. London's $1/r^6$) is much faster than Coulombic interactions ($1/r$). Importantly, since their origin resides in the fluctuation of charges on the colloids, their strength is *not additive*: simply summing all the pairwise interactions does not fully accurately account for man-body effects. We often rely on such two-body approximations, but we should be aware that they are a simplified scenario.\n",
        "\n",
        "### Double-layer interaction\n",
        "\n",
        "Colloids are often charged. The solution they are immersed also has an **inhomogeneous** distribution of ions: there will be\n",
        "\n",
        "-   **co-ions** (same charge as the colloid) that will be pushed away from the colloid surface, while\n",
        "\n",
        "-   **counter-ions** (opposite charge) will accumulate at the surface.\n",
        "\n",
        "These two different concentrations of oppositely charged ions form what is called a **double layer** and its property (such as its width) are obviously controlled by the number of ions in the solvent, which can be tuned by adding or removing, for example, salts.\n",
        "\n",
        "Suppose we now have two colloids of the same size and charges in the solvent. Th charges in their double layers will interact giving rise to a **repulsive interaction**. This interaction is referred to as **screened-Coulomb** (as the electrostatic interaction is *screened by the presence of the ions* or **double layer repulsion.** We are not going to derive it, but it can be shown that, for a colloid of radius $R$ in solvent with salt density $n_s$ it can approximated by an exponential decay\n",
        "\n",
        "::: {style=\"border: 2px solid red; padding: 1em; border-radius: 8px; background-color: transparent;\"}\n",
        "$$\n",
        "W_{DR}(h) = B\\dfrac{R}{\\lambda_B}\\exp{(-h/\\lambda_D)}\n",
        "$$\n",
        ":::\n",
        "\n",
        "where $\\lambda_D$ is called the **Debye length**\n",
        "\n",
        "$$\n",
        "\\lambda_D = \\sqrt{\\dfrac{1}{8\\pi\\lambda_B n_s}}\n",
        "$$\n",
        "\n",
        "while $\\lambda_B$ is the **Bjerrum length**, which is itself derived from the characteristic distance at which two elementary charges have energy $k_B T$ [^soft-matter_colloids-2]\n",
        "\n",
        "[^soft-matter_colloids-2]: As you see, scaling by $k_B T$ is a recurrent feature of soft matter.\n",
        "\n",
        "$$\n",
        "\\lambda_B = \\dfrac{e^2}{4\\pi \\varepsilon_0\\varepsilon_r k_B T}\n",
        "$$\n",
        "\n",
        "The coefficient $B$ is a material properties that depend on the surface potential. We are not going more into the details of these features, which are important for the design of colloidal experiments.\n",
        "\n",
        "------------------------------------------------------------------------\n",
        "\n",
        "From our point of view, what matters is that identical colloids in solution appear to have two interactions of opposite sign\n",
        "\n",
        "-   a van der Waals components, typically attractive and emergent from induced dipole -dipole ineractions emerging from quantum fluctuations of the electronic clouds\n",
        "\n",
        "-   a double layer component, repulsive in nature, and resulting from the electrostatic repulsions induced by ions and counterions\n",
        "\n",
        "The **sum** of the two gives rise to the **DLVO** (Derjaguin–Landau–Verwey–Overbeek) **interaction** which is an elementary model for colloid stability and aggregation.\n",
        "\n",
        "```{pyodide}\n",
        "#| autorun: true\n",
        "\n",
        "import numpy as np\n",
        "import matplotlib.pyplot as plt\n",
        "\n",
        "R = 1.0  # Radius of the colloid (micron) \n",
        "h = np.linspace(2.01 * R, 2+R*2, 1000)  # Separation distance (h > 2R)\n",
        "# Van der Waals attractive potential\n",
        "def van_der_waals_potential(h, R, A_H):\n",
        "    f_h_R = (2 * R**2 / (h**2 - 4 * R**2)) + (2 * R**2 / h**2) + np.log((h**2 - 4 * R**2) / h**2)\n",
        "    return -A_H * f_h_R\n",
        "# double layer repulsive potential\n",
        "def double_layer(h, R,B,ns ):\n",
        "    lambdaB = 0.0007 # typical Bjerrum length for water at 25 degrees (micron)\n",
        "    lambdaD = np.sqrt(1/(8*np.pi*lambdaB*ns))\n",
        "    print(\"Debye length of\", lambdaD)\n",
        "    return  B*R/lambdaB*np.exp(-h/lambdaD)\n",
        "\n",
        "\n",
        "```\n",
        "\n",
        "```{pyodide}\n",
        "#| caption: \"DLVO potential [press ctrl/cmd [ENTER] to run]\"\n",
        "#| autorun: true\n",
        "# parameters: CHANGE them to explore the interaction!\n",
        "\n",
        "A_H = 1.0  # Hamaker constant (kBT)\n",
        "B = 50.0 # double layer energy scale \n",
        "salt_ns = 2000 # salt concentration (particles/micron^3)\n",
        "\n",
        "# compute potentials\n",
        "W_vdW = van_der_waals_potential(h, R, A_H)\n",
        "W_DR = double_layer(h, R, B,salt_ns)\n",
        "DLVO = W_vdW+W_DR\n",
        "\n",
        "\n",
        "import plotting\n",
        "plotting.multi_plot(h, W_vdW, W_DR,DLVO,\n",
        "    xlabel=\"h [µm]\", ylabel=\"Interaction strength [kBT]\")\n",
        "# nicer cliping\n",
        "ylim  = max(DLVO.max(),0.5)\n",
        "plt.ylim(-ylim*1.1, ylim*1.1)\n",
        "plt.show()\n",
        "```\n",
        "\n",
        "::: {.callout-important appearance=\"simple\"}\n",
        "## Activity\n",
        "\n",
        "Modify the script above and test graphically that:\n",
        "\n",
        "1.  When the salt concentration is low, the double layer repulsion dominates the DVLO interaction\n",
        "2.  There are salt concentrations where two minima occur in the DLVO potential: on at very close distance (dominated by the Van der Waals attraction) and one, much shallower, at intermediate distances comparable to $2(R+\\lambda_D)$ . This minimum can lead to weak aggregation of colloids\n",
        "3.  Large salt concentrations depress the DVLO maximum altogether and eventually the Van der Waals interaction dominates.\n",
        ":::\n",
        "\n",
        "### Steric interactions and depletion interactions\n",
        "\n",
        "We have seen that quantum fluctuations from the uncertainty principle can be recast via a semi-classical approach into effective short-range interactions (van-der Waals). Another fundamental quantum principle -- Paulis's **exclusion principle** -- is also at the source of key effective interactions that can be understood in a semi-classical picture. Indeed, the main consequence of the exclusion principle is that since electrons cannot occupy the same quantum state, there are minimal distances below which atoms cannot be brought together.\n",
        "\n",
        "This simply means that as we take a pair of atoms, below a certain distance they **repel** each other with very strong forces, even in the absence of double layer interactions. These **repulsive interactions** can be approximated in various ways: their strength depends on the details of the atoms and hence, in the case of colloids, on the details of the materials composing the colloids. We call these excluded volume interactions **steric interactions**[^soft-matter_colloids-3].\n",
        "\n",
        "[^soft-matter_colloids-3]: From the Greek στερεός, \"solid, three-dimensional\".\n",
        "\n",
        "These fundamentally repulsive interactions mean that that, in a system with $N$ colloids, an additional $N+1$ colloid does not have access to the entire configuration space: there is a large **excluded volume** due to the presence of the other colloids.\n",
        "\n",
        "What is intriguing of these interactions is that, even if they are purely repulsive, they can collectively give rise to effective attractive interactions: **attraction through repulsion**.\n",
        "\n",
        "#### A simple example: particles in a one-dimensional line (*hard rods*)\n",
        "\n",
        "As an introductory example, let us consider a very simple, idealised system of purely repulsive objects. Let us confine them along a one dimensional line, bounded by hard (repulsive and impenetrable) walls seperated by the distance $L$. Assume the objects to be $N$ spheres of diameter $d$, or (equivalently) *hard rods* of length $d$. They cannot overlap so, once they are placed along the line, their order cannot change.\n",
        "\n",
        "What we want to know is how these hard objects, that interact solely via repulsive interactions, distribute themselves along the line. The problem is a classic of statistical mechanics and thanks to its one-dimensional nature can be addrssed extensively using analytical methods. \n",
        "\n",
        "Here we take a more algorithmic approach, and directly sample the probability density distribution $\\rho(x)$ of finding a particle center at position $x$. \n",
        "\n",
        "To do so, we do the following:\n",
        "\n",
        "::: {.callout-note appearance=\"simple\"}\n",
        "\n",
        "# Algorithm\n",
        "\n",
        "1. position the particles in a valid configuration (no overlaps with other particles or the walls)\n",
        "2. pick a particle at random\n",
        "3. move it slightly along the line \n",
        "4. test the if the new position is valid (no overlaps)\n",
        "5. if valid, accept the move otherwise, reject \n",
        "6. go back to (2)\n",
        "\n",
        ":::\n",
        "\n",
        "\n",
        "This very simple algorithm is based on a **trial** move and an **acception/rejection** step. This is the heart of a very popular molecular simulation method, named **Metropolis Monte-Carlo Chain method**.\n",
        "\n",
        "Here below you have a very simple implementation in `python`.\n",
        "\n",
        "```{pyodide}\n",
        "#| caption: \"1D hard particles [press ctrl/cmd [ENTER] to run]\"\n",
        "import numpy as np\n",
        "import matplotlib.pyplot as plt\n",
        "\n",
        "#number of particles \n",
        "N = 18\n",
        "# particle diameter\n",
        "d = 1.0\n",
        "# box size\n",
        "L = 24.0\n",
        "# maximum displacement and number of steps\n",
        "delta, steps =  0.5, 100000\n",
        "# initial configuration \n",
        "pos = np.linspace(d, L - d, N)\n",
        "\n",
        "def valid(p):\n",
        "    \"Check that consecutive (sorted) particles are non-overlapping\"\n",
        "    return np.all(p >= d/2) and np.all(p <= L-d/2) and np.all(np.diff(p) >= d)\n",
        "\n",
        "positions_samples = []\n",
        "\n",
        "for step in range(steps):\n",
        "    i = np.random.randint(N)\n",
        "    move = np.random.uniform(-delta, delta)\n",
        "    new_pos = pos.copy()\n",
        "    new_pos[i] += move\n",
        "    # sprting allows ot only check for consecutive particles\n",
        "    new_pos.sort()\n",
        "    if valid(new_pos):\n",
        "        pos = new_pos\n",
        "    if step % 100 == 0:\n",
        "        positions_samples.extend(pos)\n",
        "\n",
        "plt.hist(positions_samples, bins=128, range=(0, L), density=True)\n",
        "plt.xlabel(\"Position [d]\")\n",
        "plt.ylabel(\"Probability density\")\n",
        "plt.title(\"Histogram of particle positions\")\n",
        "plt.show()\n",
        "```\n",
        "\n",
        "The code should produce a final probability distribution along the $x$ axis. The main control parameter here is the **packing fraction**, i.e. $\\phi = \\dfrac{dN}{L}$, the coverage of the line. If you take high values for the packing fraction you will obserbve an interesting effect: the distribution $\\rho(x)$ displays distinctive modulations. Surely, these reflect the layering of the particles along the line, due to their hard-core interactions. However, the oscillations are even more interesting as we observe that the particles are morelikely to be found near the walls than away from them. \n",
        "\n",
        "Reflect on this point. In the complete absence of any attractive interactions, we find that the hard particles are *preferentially* located close to the walls. It is *as if* the walls exerted an *attractive force* capable of pulling the particles close to them. In reality, the force is purely statistical in nature. It ismerely the result of the **entropic** advantage that the **entire** system acquire when the particles are closer to the walls: simply put,if the first (and last) particles are close to the walls, there is more space for the particles in the middle, hence a larger number of configurations and hence larger **configurational entropy**.\n",
        "\n",
        "Even if the force is statistical, it is not less real: in this simplified case, it leads to the layering of the density profile. Its generalisation to less idiealised conditions leads to a family of forces that are essential for the aggregation of soft matter which are called **depletion interactions**.\n",
        "\n",
        "\n",
        "### Asakura-Oosawa depletion potential {#sec-ao-potential}\n",
        "\n",
        "\n",
        "![Mixture of colloids (yellow) and polymers (squiggly lines inside red circles). The depletion layers are as thick as the polymer radius (red circles) and are indicated with the dashes around the colloids. When the two layers do not overlap, the osmotic pressure due to the polymers on the colloids is balanced. When there is overlap, there is a region inaccessible to the polymers (purple) and the pressure is unbalanced, leading to aggregation.](figs/depletion.svg)\n",
        "\n",
        "The simple unidimensional scenario can be extended to a more interesting situation of hard-core colloidal particles dispersed in a medium where other smaller, repulsive particles (e.g. coiled polymers) are also dispersed. It is not important atthistage to know the details of such polymeric structures. We will ignore their internal structure and we wil also ignore their mutual interactions. We will only consider for the moment how they interact with the colloids and how this mediates an interaction *between* the colloids. We call these idealised polymers *penetrable hard spheres*.\n",
        "\n",
        "This assumption yield a great simplification: the polymers, on their own, are an ideal gas. Their chemical potnetial is given by \n",
        "\n",
        "$$\\mu = k_BT \\ln \\eta_b$${#eq-ideal-mu}\n",
        "\n",
        "We assume also to work in an ensemble at fixed volume $V$, temperature $T$ and chemical potential $\\mu$: this is the **grand canonical ensemble**. This means that we imagine that there is some ideal reservoir with which we can exchange polymers in order to maintain the chemical potential constant.\n",
        "\n",
        "The grand potential for such ideal polymers is given by \n",
        "\n",
        "$$\\Omega = -k_BT e^{\\mu/k_B T}V_{\\rm accessible}$$\n",
        "\n",
        "where $V_{\\rm accessible}$ is the accessible volume. In the absence of the colloids, the entire volume $V$ is accessible. \n",
        "\n",
        "Let's image to intrudce two colloids at separation $r$. For all $r> 2(R+\\delta)=R_d$, the accessible volume is $V_{\\rm accessible}^{\\infty}=V-2V_{\\rm exclusion}$, where $R_d$ is the **depletion radius** and $V_{\\rm exclusion}$ is the inaccessible region due to the colloid-polymer interaction around each colloid:\n",
        "\n",
        "$$\\begin{aligned}\n",
        "V_{\\rm exclusion}& = V_{\\rm outer}-V_{\\rm inner}\\\\\n",
        "&= \\dfrac{4\\pi}{3}\\left((R+\\delta)^3-R^3\\right)\n",
        "\\end{aligned}\n",
        "$$\n",
        "\n",
        "Changing the separation between the two colloids but maintaining $r>2R_d$ does not change the grand potential: there is no free energy advantage and hence no effective interaction.\n",
        "\n",
        "Instead, it is only when we take the colloids *closer* than $2R_d$ that we see a free energy difference. When $r<2R_d$ (and, obviously, $r>2R$) an overlap region is formed (the lens-shaped region of tha figur above). Its volume can be calculated simply from geometrical considerations and it is\n",
        "$$\n",
        "V_{\\mathrm{overlap}}(r)=\\dfrac{4 \\pi}{3} R_d^3\\left[1-\\frac{3}{4} \\frac{r}{R_d}+\\frac{1}{16}\\left(\\frac{r}{R_d}\\right)^3\\right]\n",
        "$${#eq-voverlap}\n",
        "\n",
        "Th new accessible volume is $$V_{\\rm accessible}\\prime=V-2V_{\\rm exclusion}+V_{\\mathrm{overlap}}$$. The interaction between the two colloids resulting from the free energy adgvantage is called **potential of mean force** $W(r)$. It is expressed as \n",
        "\n",
        "$$\n",
        "\\begin{aligned}\n",
        "W_{\\rm AO}(r) = \\Omega(r)-\\Omega^{\\infty} & =-k_BT e^{m/k_B T}\\left(V_{\\rm accessible}(r)-V_{\\rm accessible}(\\infty)\\right)\\\\\n",
        "& = -k_BT e^{m/k_B T}\\left[V-2V_{\\rm exclusion}+V_{\\mathrm{overlap}}(r)-(V-2V_{\\rm exclusion})\\right]\\\\\n",
        "& = -k_BT e^{m/k_B T} V_{\\mathrm{overlap}(r)}\n",
        "\\end{aligned}\n",
        "$$\n",
        "\n",
        "We can now re-use the ideal polymer chemical potential definition @eq-ideal-mu and the gemoetrical expression for $V_{\\mathrm{overlap}}$ in @eq-voverlap to finally write the **Asakura-Oosawa** potential\n",
        "\n",
        "<div style=\"border: 2px solid red; padding: 1em; border-radius: 8px; background-color: transparent;\">\n",
        "$$\n",
        "W_{\\rm AO} (r) = - \\dfrac{4 \\pi \\eta_b k_B T}{3} (R+\\delta)^3\\left[1-\\dfrac{3}{4} \\dfrac{r}{R+\\delta}+\\frac{1}{16}\\left(\\dfrac{r}{R+\\delta}\\right)^3\\right] \\quad 2R\\leq r< 2R+\\delta\n",
        "$$ \n",
        "</div>\n",
        "\n",
        "taking $q = \\delta / R$ (the polymer-to-colloid size ratio), so $R+\\delta = R(1+q)$ and $r/(R+\\delta) = r/[R(1+q)]$ the AO potential can also be rewritten as:\n",
        "\n",
        "$$\n",
        "W_{\\rm AO}(r) = -\\frac{4\\pi \\eta_b k_B T}{3} [R(1+q)]^3 \\left[1 - \\frac{3}{4} \\frac{r}{R(1+q)} + \\frac{1}{16} \\left(\\frac{r}{R(1+q)}\\right)^3 \\right] \\quad 2R \\leq r < 2R(1+q)\n",
        "$$\n",
        "\n",
        "```{pyodide}\n",
        "#| caption: \"Asakura-Oosawa potential [press ctrl/cmd [ENTER] to run]\"\n",
        "#| autorun: true\n",
        "\n",
        "import numpy as np\n",
        "import matplotlib.pyplot as plt\n",
        "\n",
        "# Parameters (change to explore)\n",
        "R = 1.0           # Colloid radius\n",
        "delta = 0.2       # Polymer radius\n",
        "eta_b = 0.1       # Polymer concentration (dimensionless)\n",
        "kBT = 1.0         # Set kBT=1 for reduced units\n",
        "\n",
        "# Depletion radius\n",
        "Rd = R + delta\n",
        "\n",
        "# r values: from contact (2R) up to 3(R+delta)\n",
        "r = np.linspace(2*R, 3*Rd, 500)\n",
        "\n",
        "def AO_potential(r, R, delta, eta_b, kBT):\n",
        "    Rd = R + delta\n",
        "    # Only defined for 2R <= r < 2Rd\n",
        "    W = np.zeros_like(r)\n",
        "    mask = (r >= 2*R) & (r < 2*Rd)\n",
        "    x = r[mask] / Rd\n",
        "    W[mask] = - (4 * np.pi * eta_b * kBT / 3) * Rd**3 * (1 - 0.75 * x + 0.0625 * x**3)\n",
        "    return W\n",
        "\n",
        "W_AO = AO_potential(r, R, delta, eta_b, kBT)\n",
        "\n",
        "plt.plot(r, W_AO)\n",
        "plt.gca().set(xlabel=\"Separation $r/R$\", ylabel=\"$W_{AO}(r)$\", title=\"Asakura-Oosawa Depletion Potential\")\n",
        "plt.show()\n",
        "```\n",
        "\n",
        "::: {.callout-note collapse=\"true\"}\n",
        "# Force-based derivation of the AO interaction\n",
        "\n",
        "When the colloids are so close the polymers cannot enter the lens-shaped region between the two colloids. This gap leads therefore to an *uniform* distribution of polymers which results in an pressure difference: the outer polymers push the colloids together, producing an effective attractive force. Such pressure resulting from an uncompensated concentration gradient is called **osmotic**.\n",
        "\n",
        "The lens-shaped overlap region between the two colloids consists of two identical spherical caps, each subtending an angle $\\theta_0$ at the center of the colloid. From the given geometry, the angle is such that $$\\cos\\theta_0 = \\dfrac{r}{2R_d}.$$ \n",
        "\n",
        "The uncompensated pressure acts on such surface.\n",
        "\n",
        "For symmetry reasons, only the forces along the axis connecting the wto spheres contribute to the total force. For a given angle $\\theta$ the components is proportional to $P\\cos\\theta$ where $P$ is the pressure exerted by the ideal gas of polymers is simply $P=\\eta_b kT$ where $\\eta_b$ is the polymer concentration. The surface element on which this pressure acts for a small increment $d\\theta$ is $$dS = 2\\pi R_d^2\\sin\\theta d\\theta$$. Integrating over the range $[0,\\theta_0]$  yields the total force $F_d$ \n",
        "\n",
        "$$\n",
        "\\begin{aligned}\n",
        "F_d(r) &= -2\\pi \\eta_b k_B T R_d^2 \\int_0^{\\theta_0} \\sin\\theta \\cos\\theta \\, d\\theta \\\\\n",
        "&= -\\pi R_d^2 \\eta_b k_B T \\left[1 - \\left(\\frac{r}{2R_d}\\right)^2\\right]\n",
        "\\end{aligned}\n",
        "$$\n",
        "\n",
        "Notice the negative sign, chosen to reflect the fact that the force is attarctive.\n",
        "\n",
        "Integrating the force yields the interaction potential. \n",
        ":::\n",
        "\n",
        "::: {.cell}\n",
        "```{=live-html}\n",
        "![Animation of two dimensional colloids in a sea of ideal polymers. Notice how the initially separated colloids ultimately come close to each other](figs/aoanimation.gif){format: live-html}\n",
        "```\n",
        ":::\n",
        "\n",
        "::: {.cell}\n",
        "```{=latex}\n",
        "% Skip this GIF in PDF\n",
        "```\n",
        ":::\n",
        "\n",
        "\n",
        "::: column-margin\n",
        "::: {.content-visible when-format=\"live-html\"}\n",
        "![Fumio Oosawa (front) and Sho Asakura at Oosawa's 88th birthday (from @kurihara2021discovery )](figs/aobirthday.png)\n",
        ":::\n",
        ":::\n",
        "\n",
        "::: {.callout-note}\n",
        "# Summary of main colloid-colloid interactions\n",
        "+------------------+-----------------------------------------------------------------------------------------------+----------------------+\n",
        "| Interaction Type | Description                                                                                   | Range                |\n",
        "+==================+===============================================================================================+======================+\n",
        "| Van der Waals    | Attractive forces arising from induced dipoles between particles.                             | Short-range          |\n",
        "+------------------+-----------------------------------------------------------------------------------------------+----------------------+\n",
        "| Double Layer     | Electrostatic repulsion due to overlapping electrical double layers around charged particles. | Long-range           |\n",
        "+------------------+-----------------------------------------------------------------------------------------------+----------------------+\n",
        "| DLVO             | Combination of van der Waals attraction and double layer repulsion.                           | Short and long range |\n",
        "+------------------+-----------------------------------------------------------------------------------------------+----------------------+\n",
        "| Depletion        | Typically attractive interactions emerging from purely entropic interactions                  | Short range          |\n",
        "+------------------+-----------------------------------------------------------------------------------------------+----------------------+\n",
        ":::\n",
        "\n",
        "\n",
        "## Colloids as big atoms\n",
        "\n",
        "Colloids can be viewed as \"big atoms\": they are large particles suspended in a medium, exhibiting thermal motion and interactions in various ways analogous to atoms, but at much larger length and time scales. As we have seen above, the interactionsa can have statistical or even quanto-mechanical origina, but are ultimately cast in a classical form that is amenable to a classical treatment. At the same time, the large scales of colloids mean that via dedicatated microscopy techniques one is able to identify individual colloids, study theiur arrangements in detail, and follow their dynamics.\n",
        "\n",
        "As mentionedearlier, there is a huge variety of colloids and a vast literature characterising their properties but also producing theoritical and computational models.\n",
        "\n",
        "Here we focus on the most elementary model of a colloid. The simplest such exammple is the purely repulsive hard-sphere colloid. While an idealisation, quasi-hard-sphere colloids can be prepared in the laboratory by various techniques (see @royall2024colloidal ). This includes by synthesizing a spheres of bundled polymers (you will learn about polymers in the next chapter) such as polymethyl methacrylate (PMMA), but also simply silica (small sphere of non-crystalline $\\rm Si O_2$) micron-sized beads carefully treated to screen and minimize the electrostatic interactions that would lead to DLVO-like contributions.\n",
        "\n",
        "\n",
        "\n",
        "### The archetype: hard-spheres {#sec-hard-spheres}\n",
        "\n",
        "\n",
        "A **hard-sphere** is an idealized particle model in which each particle is represented as a perfectly rigid sphere of fixed radius $R$ and diameter $\\sigma=2R$. Hard spheres interact only through excluded volume: they cannot overlap, but otherwise experience no attraction or repulsion. The interaction potential $U(r)$ between two hard spheres separated by a center-to-center distance $r$ is:\n",
        "\n",
        "$$\n",
        "U(r) = \\begin{cases}\n",
        "\\infty & \\text{if } r < \\sigma \\\\\n",
        "0 & \\text{if } r \\geq \\sigma\n",
        "\\end{cases}\n",
        "$$\n",
        "\n",
        "This model captures the essential physics of **excluded volume** which, as we said earlier, fundamentally emerges from Pauli's exclusion principle (electrons cannot occupy the same quantum state so electronic clouds of different atoms *exclude* each other).\n",
        "\n",
        "<svg width=\"400\" height=\"220\" viewBox=\"0 0 400 220\" xmlns=\"http://www.w3.org/2000/svg\">\n",
        "    <!-- Axes -->\n",
        "    <line x1=\"40\" y1=\"180\" x2=\"370\" y2=\"180\" stroke=\"black\" stroke-width=\"2\"/>\n",
        "    <line x1=\"60\" y1=\"200\" x2=\"60\" y2=\"30\" stroke=\"black\" stroke-width=\"2\"/>\n",
        "    <!-- x axis label -->\n",
        "    <text x=\"360\" y=\"195\" font-size=\"16\" font-family=\"sans-serif\">r</text>\n",
        "    <!-- y axis label -->\n",
        "    <text x=\"30\" y=\"40\" font-size=\"16\" font-family=\"sans-serif\" transform=\"rotate(-90 30,40)\">U(r)</text>\n",
        "    <!-- Hard sphere potential: vertical line at r=2R, infinite wall -->\n",
        "    <line x1=\"120\" y1=\"180\" x2=\"120\" y2=\"40\" stroke=\"red\" stroke-width=\"4\"/>\n",
        "    <!-- Dashed line for r < 2R (forbidden region) -->\n",
        "    <rect x=\"60\" y=\"40\" width=\"60\" height=\"140\" fill=\"#f88\" fill-opacity=\"0.2\"/>\n",
        "    <!-- Label for r=2R -->\n",
        "    <text x=\"115\" y=\"195\" font-size=\"14\" font-family=\"sans-serif\" text-anchor=\"middle\">2R</text>\n",
        "    <!-- Flat line for r > 2R (U=0) -->\n",
        "    <line x1=\"120\" y1=\"180\" x2=\"360\" y2=\"180\" stroke=\"blue\" stroke-width=\"3\"/>\n",
        "    <!-- Dotted line at U=infty -->\n",
        "    <text x=\"80\" y=\"55\" font-size=\"14\" font-family=\"sans-serif\" fill=\"red\" text-anchor=\"middle\">∞</text>\n",
        "    <!-- Label for U=0 -->\n",
        "    <text x=\"70\" y=\"175\" font-size=\"14\" font-family=\"sans-serif\" fill=\"blue\">0</text>\n",
        "    <!-- Bracket for forbidden region -->\n",
        "    <text x=\"95\" y=\"210\" font-size=\"13\" font-family=\"sans-serif\" text-anchor=\"middle\" fill=\"#f88\">forbidden</text>\n",
        "    <!-- Title -->\n",
        "    <text x=\"200\" y=\"25\" font-size=\"18\" font-family=\"sans-serif\" text-anchor=\"middle\">Hard Sphere Potential</text>\n",
        "</svg>\n",
        "\n",
        "#### Phase behaviour of hard spheres {.unnumbered}\n",
        "\n",
        "Since the interaction potential is only based on excluded volume, the energy of hard spheres is trivial: it is **always zero**. A naive interpretation of such trivial energetics may lead to conclude that nothing interesting happens to a collection of hard spheres, since they always are at their energy minimum (namely, zero). However, it is clear from the earlier discussion of depletion forces that the interaction energy is only a part of the picture for systems subject to thermal fluctuations: indeed, for any $T>0$, **entropic** contributions to the free energy are always present. In the specific case of a fixed number of hard spheres in a fixed volume, they are *the only* contribution to the free energy.\n",
        "\n",
        "In this sense, hard-spheres are completely **entropy-driven** system. For a collection of identical (**monodisperse**) hard spheres the entropy is solely **configurational** and correspods to the number of possible arrangements. This constrained only by the accessible volume, of which we have seen an instance when considering the depletion interactions. Notice that changing the temperature does not really affect the statistics of the configurations: the Boltzmann factor $e^{U(\\mathbf{r}^N)/k_BT}$ is always $1$ for all valid configurations. The only way we can change the state of the system is by varying the accessible volume. For a system of $N$ identical hard spheres in a volume $V$ this can only be done in two ways\n",
        "\n",
        "- by adding more spheres (of the same kind)\n",
        "- by varying the volume V\n",
        "\n",
        "The two routes essentially amount to varying one single parameter, which is the **packing fraction** (also called, *volume fraction*) of the system, defined as \n",
        "\n",
        "$$\\phi = N\\dfrac{v_{\\rm sphere}}{V} = \\dfrac{\\pi \\sigma^6 N}{6V}$$\n",
        "\n",
        "which can also be expressed in terms of the **number density** $\\rho=N/V$ as $\\phi=\\pi\\sigma^3\\rho/6$. \n",
        "\n",
        "To change the phase behaviour of hard spheres we have a **single control parameter**, $\\phi$ meaning that (differently from fluids like water) we are bound to have **one-dimensional** phase diagram. \n",
        "\n",
        "We explore the phase behaviour of hard spheres by considering different regimes of packing fraction.\n",
        "\n",
        "#### Low packing fractions {.unnumbered}\n",
        "\n",
        "The hard repulsion between hard spheres means that each sphere is surrounded by an excluded volume in which the center of other spheres cannot be placed. Since the distance of closest approach between two spheres is $\\sigma$ such **excluded volume** per particle is simply $v_{\\rm ex} =4\\pi\\sigma^3/3$ and it is much larger than the volume pert particle $v= V/N$. A collection of $N$ hard spheres has a total excluded volume $V_{\\rm ex}\\neq N v_{\\rm ex}$ simply because the  excluded volumes of individual particles can in general overlap, as we saw earlier with the case of depletion.\n",
        "\n",
        "At very low densities, most hard spheres isolated. So, in this case, we can approximate the roral excluded volume as $V_{\\rm ex} \\rm N v_{\\rm ex}$ so that the accessible volume (the volume not occupied by the spheres) is\n",
        "\n",
        "$$V_{\\rm accessible} = V-Nv_{\\rm ex}$$\n",
        "\n",
        "We use this to perform an appropriate statistical mechanical calculation for the  Helmholtz free energy of system $F$, which we know is purely entropic $F=-TS$. The partition function $\\mathcal{Z}$ is \n",
        "\n",
        "$$\n",
        "\\mathcal{Z} = \\frac{1}{N! \\Lambda^{3N}} \\int_{V_{\\rm accessible}} d\\mathbf{r}_1 \\ldots d\\mathbf{r}_N\n",
        "$$\n",
        "\n",
        "where $\\Lambda$ is the  thermal de Broglie wavelength \n",
        "\n",
        "$$\\Lambda = h/\\sqrt{2\\pi mk_B T},$$\n",
        "and originates from the integration over the Maxwell-Boltzmann disribution of momenta for particles of mass $m$, while $h$ is Planck's constant.\n",
        "\n",
        "\n",
        "For hard spheres, the integral is over all configurations where no two spheres overlap (i.e., $|\\mathbf{r}_i - \\mathbf{r}_j| \\geq \\sigma$ for all $i \\neq j$), and $V_{\\rm accessible}$ is the total accessible volume. The results is that \n",
        "\n",
        "$$\\mathcal{Z} = \\dfrac{(V-Nv_{\\rm ex}/2)^N}{N!\\Lambda^{3N}},$$\n",
        "\n",
        "\n",
        "with the $1/2$ factor coming from the fact that we avoid double counting the excluded volume of pairs.  The entropy is\n",
        "$$\n",
        "S = k_B \\ln \\mathcal{Z} = k_B \\left[ N \\ln(V - N v_{\\rm ex}/2) - \\ln N! - 3N \\ln \\Lambda \\right]\n",
        "$$\n",
        "\n",
        "From the partition function, we use Stirling's formula $\\ln N! = N\\ln N -N$ and obtain\n",
        "\n",
        "$$\n",
        "S = k_B \\left[ N \\ln(V - N v_{\\rm ex}/2) - (N \\ln N - N) - 3N \\ln \\Lambda \\right]\n",
        "$$\n",
        "\n",
        "which reads\n",
        "$$\n",
        "S = N k_B \\left[ \\ln\\left( \\frac{V - N v_{\\rm ex}/2}{N \\Lambda^3} \\right) + 1 \\right]\n",
        "$$\n",
        "\n",
        "\n",
        "The phase behaviour is encoded in the **equation of state** (the equation that links the three thermodynamics variables $P,T$ and $\\phi$). To obtain it, we calculate the pressure\n",
        "\n",
        "$$P = -\\left(\\dfrac{\\partial F}{\\partial V}\\right)_{N,T} =T\\left(\\dfrac{\\partial S}{\\partial V}\\right)_{N,T}= \\dfrac{k_B T }{v-v_{\\rm ex}/2}$$ \n",
        "\n",
        "This expression can be simplified (do it as an exercise) to obtain the quation of state\n",
        "\n",
        "$$Z_{\\rm comp}= \\dfrac{PV}{Nk_BT}=\\dfrac{1}{1-4\\phi} \\quad (\\phi\\ll 1)$$\n",
        "\n",
        "also known as the **compressibility factor** $Z_{\\rm comp}$. Since $\\phi$ is very small the expression is in fact\n",
        "\n",
        "\n",
        "::: column-margin\n",
        "The choice of the letter \"Z\" is unfortunate. Do not confuse the compressibility factor with the partition function! \n",
        ":::\n",
        "\n",
        "$$Z_{\\rm comp} = 1+4\\phi+O(\\phi^2)$$\n",
        "\n",
        "This expression makes it apparent that the first term linear in $\\phi$ is a *correction* to the ideal gas law. This is example (to very low order) of what is called the **virial expansion**. This, in general takes the form \n",
        "\n",
        "$$Z_{\\rm comp}= 1 + B_2 \\rho + B_3 \\rho^2+ \\dots$$\n",
        "\n",
        "where $B_2, B_3, \\dots$ are the **virial coefficients** and for systems that are not hard spheres they depend also on the temperature, $B_2(T), B_3(T),\\dots$. They are important as they encode the effects of **correlations**:\n",
        "\n",
        "- $B_2$ accounts for pairwise correlations (how the presence of one particle affects the probability of finding another nearby),\n",
        "- $B_3$ for three-body correlations, and so on.\n",
        "\n",
        "Given an interaction potential the second virial coefficient $B_2$ can be calculated  independently from the equation state \n",
        "\n",
        "$$\n",
        "B_2(T)=-\\frac{1}{2} \\int_0^{\\infty}\\left(\\exp \\left(-\\frac{U(r)}{k_B T}\\right)-1\\right) 4 \\pi r^2 d r \n",
        "$$\n",
        "\n",
        "For hard spheres this results in\n",
        "\n",
        "$$\n",
        "B_2 =  \\frac{2\\pi}{3} \\sigma^3\n",
        "$$\n",
        "\n",
        "\n",
        "which is exactly what is predicted by the equation of state above, once you recognise that $\\phi = \\frac{\\pi\\sigma^3}{6}\\rho$. \n",
        "\n",
        "\n",
        "::: column-margin\n",
        "Exercise: check this calculation.\n",
        ":::\n",
        "\n",
        "Higher-order coefficients become increasingly complex to compute and reflect more complex many-body corelations that can be established even if the interaction potential is purely twobody (as in the case of hard spheres). The higher order coefficients become mor eand more important as the packing fraction is increased. Eventually something surprising occurs at a sufficiently high volume fraction.\n",
        "\n",
        "#### Dense packing: metastability and crystalisation {.unnumbered}\n",
        "\n",
        "As we increase the packing fraction, the accessible (free) volume reduces rapidly. At some point, disordered packing of spheres are so tightly packed that thermal motion becomes extremely inefficient or even impossible. Such disordered (**random**) packing of spheres are described as **jammed**: they are so densely packed that they are no longer behaving like a fluid but they instead display some of the rigidity that we typically associate with solids. Such jammed configurations are indeed examples of **amorphous solids**. We will explore them more in detail in the chapter dedicated to arrested systems.\n",
        "\n",
        "It is important to note, however, that the disordered packing at high volume fractions are not minima of the free energy. The densest possible packing of hard spheres is achieved by arranging them in a crystalline lattice. In three dimensions, the densest packings are the face-centered cubic (FCC) and hexagonal close-packed (HCP) structures, both of which have a maximum packing fraction of\n",
        "\n",
        "$$\n",
        "\\phi_{\\text{max}} = \\frac{\\pi}{3\\sqrt{2}} \\approx 0.74\n",
        "$$\n",
        "\n",
        "\n",
        "This means that, at most, about 74% of the available volume can be filled by the spheres, with the remainder being empty space. This result was conjectured by Kepler in 1611 and proved rigorously only in 1998 (the [Kepler conjecture](https://en.wikipedia.org/wiki/Kepler_conjecture)).\n",
        "\n",
        "In contrast, **random close packing** (the densest disordered arrangement of spheres) yields a lower packing fraction, typically around $\\phi_{\\text{rcp}} \\approx 0.64$. Notice that this value is approximate and variations can be observed (due to randomness and, more importantky, to the method by which such packing are reached, i.e. the *compression protocol*). This means that the only way to compress spheres at very high packing has to lead (*spontaneously*) to the formation of crystals. We can indeed imagine to perform the following experiment: \n",
        "\n",
        " - prepare a disordered assembly of colloidal hard spheres\n",
        " - compress them gradually to high and higher packing fraction, taking care to monitor the systems so that time correlations decay and the system is at thermal equilibrium\n",
        " - measure the resulting packing fraction\n",
        "\n",
        " Experiments of this sort have been performed historically, leveraging for example the **slow sedimentation** of colloids, which on long time scales leads to the accumulation of dense packings of spheres. Such experiments reveal that beyond the so-called **freezing packing fraction** $\\phi_{f} 0.494$ the system spontaneously forms small regions of crystals mixed with the fluid. At a the high **melting packing fraction** $\\phi_{m}=0.545$ the entirety of the system is then crystalline and its optical properties consequently change. \n",
        "\n",
        "\n",
        " ![Phase behaviour of hard-sphere colloids from @pusey2009hard ](figs/rsta20090181f01.jpg)\n",
        "\n",
        " A simple **cell model** can help us rationalise what is taking place. When the spheres are packed within their FCC cell, they can move very little beyond their own diameter $\\sigma$. Assume that the volume per particle again is $v$ and the (geometrically consrained) close packed volume is $v_{cp}$.\n",
        "\n",
        " The maximum dispalcement is \n",
        " $$\n",
        "\\delta=\\frac{\\sigma}{\\sqrt{2}}\\left(\\left(\\frac{v}{v_{c p}}\\right)^{1 / 3}-1\\right)\n",
        "$$\n",
        "The corresponding free volume is then $v_f=\\frac{4 \\pi}{3} \\delta^3$ from which we can calculate the entropy\n",
        "\n",
        "$$\n",
        "S = -N k_B T \\ln \\left(v_f / \\Lambda^3\\right)\n",
        "$$\n",
        "\n",
        "and the resulting pressure \n",
        "\n",
        "$$\n",
        "P=\\frac{N k_B T}{v_{c p}} \\frac{\\left(v / v_{c p}\\right)^{-2 / 3}}{\\left(v / v_{c p}\\right)^{1 / 3}-1}\n",
        "$$\n",
        "\n",
        "Rearranging and expressing everything in terms  of packing fraction $\\phi = \\dfrac{\\pi\\sigma^3}{6v}$ yields \n",
        "\n",
        "$$\n",
        "Z_{\\rm comp}=\\frac{1}{1-\\left(\\phi / \\phi_{c p}\\right)^{1 / 3}}\n",
        "$$\n",
        "\n",
        "What is noteable here is that the expression we have obtained is a completely different functional form compared to the low density fluid regime. Thisis indicative of a **discontinuous**, **first-order** phase transition between the fluid and the crystalline phases. First order phase transitions are characterised by coexisting regions where the system can be found in partial fluid and partial crystaline state, as illustrated in the experiments above. This also means that we can prepare a disordered packing at very high density: this will not be its equilibrium state (global minimum of the free energy), but will still be stable for some (finite) time. This *local equilibrium state* is called a ***metastable state**.\n",
        "\n",
        "\n",
        "![Schematic free energy for hard spheres compressed at high pressures: the fluid branch becomes metastable and the free enrgy minimum is located in the crystal phase](figs/metastable.png)\n",
        "\n",
        "But where does the free energy advantage of the crystal over the disrodered fluid come from? From the discussion above the answer is obvious: crystals can accommodate higher packings, meaning that they use the availale volume more efficiently. This in fact means that (on average) every hard sphere has more available volume if it arranged in the crystalline state compared to the fluid phase: the increased volume (available for thermal fluctuations and random particle displacements) is translated into an **increased entropy**. So, in fact the ordered, crystalline state has overall a higher entropy than the disordered fluid. This is important instance in which the conventional storytelling, where entropy is just **disorder**, simply does not hold. As we have seen with depletion forces earlier, entropy can lead to structure: in the case of hard spheres, it si the only mechanism leading to structure, and such structure is the most orderly one can think of: long-range, crystalline order.\n",
        "\n",
        "The video below shows instead the results of a Monte-Carlo simulation at packing $\\phi=0.493$ for a small system of 32 particles. Small systems have enhanced fluctuations, and since the overal packing fraction is very close to the freezing line, we see spontaneous freezing and unfreezing of the small system (wait until second 14 in the movie).\n",
        "\n",
        "{{< video figs/melt_freeze.mp4 >}}\n",
        "\n",
        "In conclusion, colloidal hard spheres have a one-dimensional phase diagram, that depends only on the packing fraction but with various distinct phases\n",
        "\n",
        "![Hard-spheres phase diagram](figs/hard-sphere-diag.svg)\n",
        "\n",
        "\n",
        "\n",
        "### Beyond hard-spheres: simple liquids\n",
        "\n",
        "A **simple liquid** is a system of particles interacting via short-range, spherically symmetric (isotropic) pair potentials. The most common model is the **Lennard-Jones (LJ) potential**, which captures both the short-range repulsion (due to Pauli exclusion) and longer-range van der Waals attraction:\n",
        "\n",
        "$$\n",
        "U_{\\mathrm{LJ}}(r) = 4\\epsilon \\left[ \\left( \\frac{\\sigma}{r} \\right)^{12} - \\left( \\frac{\\sigma}{r} \\right)^6 \\right]\n",
        "$$\n",
        "\n",
        "where $\\epsilon$ sets the depth of the potential well (interaction strength) and $\\sigma$ is the particle diameter (distance at which $U=0$). The $r^{-12}$ term models steep repulsion, while $r^{-6}$ describes the attractive tail.\n",
        "\n",
        "The Lennard-Jones fluid exhibits rich phase behavior: at low temperatures and densities, it forms a gas; at intermediate conditions, a liquid; and at high densities, a solid. The LJ model is widely used to study atomic and molecular liquids, and serves as a reference for understanding real fluids and their phase transitions.\n",
        "\n",
        "In the phase diagram below these different phases have been highlighted. It is clear that, compared to hard spheres which only display a fluid and a crystalline solid phase, systems like the Lennard-Jones fluid display an additional phase, the **liquid**. This phase emerges from the presence of the attractive well in the interaction potential. This allows for short-range attractive interactions that case a region of teh phase diagram in the save class of universality of the [**Ising model**](../phase-transitions/Ising-model.qmd) and the [**lattice gas**](../phase-transitions/lattice-gas.qmd).\n",
        "\n",
        "\n",
        "![Phase diagram of the Lennard-Jones Fluid, adapted from Wikimedia.](figs/LJPhaseDiagram.png)\n",
        "\n",
        "The Lennard-Jones interaction has already been designed to model noble gases (e.g. Argon) but has over time been used to model many other systems due to its simplicity and computational convenince: in particular it is used tor construct coarse-grained models of macromolecules, as well as colloids and nanoparticles. It belongs to a wider class of, classical, effective **pair-wise** interaction models actensively used to claculate properties and phase diagrams of a variety of condensed matter systems. This are useful because they allow one to, for example, long molecular simulations that are normally unreachable when considering atomistics and electronic density calculations. \n",
        "\n",
        "The following table provides you with a few example potentials and their functional forms:\n",
        "\n",
        "| Potential Name      | Mathematical Form                                                                 | Typical Systems/Features                        |\n",
        "|---------------------|-----------------------------------------------------------------------------------|-------------------------------------------------|\n",
        "| Lennard-Jones (LJ)  | $U(r) = 4\\epsilon \\left[ \\left( \\frac{\\sigma}{r} \\right)^{12} - \\left( \\frac{\\sigma}{r} \\right)^6 \\right]$ | Simple atomic fluids, coarse-grained molecular interactions               |\n",
        "| Hard Sphere         | $U(r) = \\begin{cases} \\infty & r < \\sigma \\\\ 0 & r \\geq \\sigma \\end{cases}$       | Colloids, granular materials, excluded volume   |\n",
        "| Yukawa (Screened Coulomb) | $U(r) = \\epsilon \\frac{e^{-\\kappa r}}{r}$                                   | Charged colloids, plasmas, electrolytes         |\n",
        "| Dipolar             | $U(r) = \\frac{\\mu_0}{4\\pi} \\frac{\\mu_1 \\mu_2}{r^3} (1 - 3\\cos^2\\theta)$           | Magnetic colloids, polar molecules              |\n",
        "\n",
        "\n",
        "\n",
        "## Characterisation of colloidal systems\n",
        "\n",
        "When looking at colloidal systems, we typically focus on two main aspects of their physics:\n",
        "\n",
        "- their **structural features**, chracterised by the **spatial** correlations between their constituents\n",
        "- their **dynamical features**, characterised by the mobility of single particles or groups of particles.\n",
        "\n",
        "Here below, we briefly account of some main approaches to characterise these two dimensions.\n",
        "\n",
        "### Structural properties: the radial distribution function\n",
        "\n",
        "Structural features of disordered (but also ordered) systems are described in terms of **correlation functions**. The underlying idea is that we are provided with an ensemble of stochastic variables (the positions of the colloids) which have a characteristic spatial distribution. for $N$ particles we have an N-body probability distribution function $\\rho_N(\\mathbf{r}^N)$ which contains all the necessary statistical mechanical information to describe the thermodyanmics of the system. However, this is very difficult to access directly. In experiments or theoretical calculations we typically only have access to some lower order *marginalisation* of the distribution, in terms of few-body distributions.\n",
        "\n",
        "One of the simplest assumptions we can make when we describe a system is that its potential energy is expressed in terms of purely pairwise additive potential, meaning that \n",
        "\n",
        "$$ U_N (\\mathbf{r}^N)=\\sum_{i=1}^{N-1}\\sum_{j=i+1}^N V(r_ij) = \\dfrac{1}{2}\\sum_{i\\neq j}V(r_{ij})$$\n",
        "\n",
        "where $V(r_{ij})$ is the pairwise, radial interaction potential that only depends on the distance between particle centres $r_{ij} = \\mathbf{r}_i-\\mathbf{r}_j$.\n",
        "\n",
        "For system with pariwise interactions, the natural spatial correlation function is a twobody correlation $g(\\mathbf{r}_i, \\mathbf{r}_j)$, where $\\mathbf{r}_i$ and $\\mathbf{r}_j$ are two randomly chosen particles. In the case of non-crystalline, disordered systems the corrlation function has to be\n",
        "\n",
        "- translationally invariant , so that it only depends on the difference $\\mathbf{r}_i-\\mathbf{r}_j$\n",
        "- rotationally invariant, so that there is no angular component and hence only the distance $r_{ij} =| \\mathbf{r}_i-\\mathbf{r}_j|$ matters\n",
        "\n",
        "This function $g(r)$ is called the **radial distribution function** and plays a crucial role in the characterisation of fluids, crystals, glasses and much more. For system with twobody interactions only, it contains in principle all the thermodynamic information necessary to reconstruct the free energy, as one can write \n",
        "\n",
        "$$\n",
        "\\frac{F_{\\mathrm{ex}}}{k_B T}=2 \\pi \\rho N \\int_0^{\\infty}[g(r) \\ln g(r)-g(r)+1] r^2 d r+\\frac{\\rho N}{2 k_B T} \\int V(r) g(r) d^3 r\n",
        "$$\n",
        "where the first term represent the entropic contributions and the second term represents the energetic contribution.\n",
        "\n",
        "But how is it calculated? very simply. You can think of constructing a histogram of the distances between all of the particles and suitably normalising such histogram by the density of the system. Mathematically this reads as\n",
        "<div style=\"border: 2px solid red; padding: 1em; border-radius: 8px; background-color: transparent;\">\n",
        "$$\n",
        "g(r) = \\frac{1}{\\rho N} \\left\\langle \\sum_{i=1}^N \\sum_{j \\neq i} \\delta(|\\mathbf{r}_i - \\mathbf{r}_j| - r) \\right\\rangle\n",
        "$$\n",
        "</div>\n",
        "\n",
        "where $\\rho = N/V$ is the number density, and the angle brackets denote an ensemble average and $\\delta$ is a Dirac delta function.\n",
        "\n",
        "- For an **ideal gas**, $g(r) = 1$ everywhere (no correlations).\n",
        "- For **hard spheres**, $g(r) = 0$ for $r < \\sigma$ (no overlap), and $g(r)$ shows oscillations at higher $r$ due to packing effects.\n",
        "\n",
        "Notice that the radial distribution function is an instance of the more general class of pair-wise correlations that have been introduced earlier, see @sec-correlations and it is paired with its reciprocal space Fourier transform, the **structure factor**:\n",
        "\n",
        "$$\n",
        "S(k) = 1 + \\rho \\int \\left[ g(r) - 1 \\right] e^{-i \\mathbf{k} \\cdot \\mathbf{r}} d\\mathbf{r}\n",
        "$$\n",
        "\n",
        "For isotropic systems, this reduces to:\n",
        "\n",
        "$$\n",
        "S(k) = 1 + 4\\pi \\rho \\int_0^\\infty r^2 [g(r) - 1] \\frac{\\sin(kr)}{kr} dr\n",
        "$$\n",
        "\n",
        "Experimentally, on can measure $S(k)$ can be measured using scattering techniques or $g(r)$ via direct imaging in colloidal systems. They provide insight into short-range order, local structure, and phase transitions in soft matter.\n",
        "\n",
        "::: {.callout-important appearance=\"simple\"}\n",
        "The radial distribution function $g(r)$ has two possible interpretations\n",
        "\n",
        "- It represents the probability density of finding a particle at distance $r$ away from a reference particle *relative* to the probability density of an idela gas at the same number density.\n",
        "- If a given refernce particle is taken at the origin, then the local average density at distance $r$ is $\\rho g(r)$.\n",
        "\n",
        ":::\n",
        "\n",
        "Here below we show two codes to calculate the radial distribution fucntion for an ideal gas (which is trivial) and then for an assembly of hard spheres\n",
        "```{pyodide}\n",
        "#| caption: \"Radial distribution function of an ideal gas [press ctrl/cmd [ENTER] to run]\"\n",
        "#| autorun: true\n",
        "import numpy as np\n",
        "import matplotlib.pyplot as plt\n",
        "\n",
        "# Parameters\n",
        "N = 500      # number of points, change this to check convergence\n",
        "L = 10.0     # box size\n",
        "bins = 50    # number of bins\n",
        "\n",
        "# Generate random points (ideal gas)\n",
        "positions = np.random.uniform(0, L, size=(N, 3))\n",
        "\n",
        "def radial_distr(positions, L):\n",
        "    N = len(positions)\n",
        "    \n",
        "    # Compute all pairwise distances with PBC\n",
        "    diff = positions[:, np.newaxis, :] - positions[np.newaxis, :, :]\n",
        "    diff = diff - L * np.round(diff / L)\n",
        "    dists_matrix = np.sqrt(np.sum(diff**2, axis=-1))\n",
        "    \n",
        "    # Get upper triangular distances (each pair counted once)\n",
        "    i, j = np.triu_indices(N, k=1)\n",
        "    dists = dists_matrix[i, j]\n",
        "    \n",
        "    # Create histogram\n",
        "    r_max = L/2\n",
        "    r_edges = np.linspace(0, r_max, bins+1)\n",
        "    hist, _ = np.histogram(dists, bins=r_edges)\n",
        "    r_centers = 0.5 * (r_edges[:-1] + r_edges[1:])\n",
        "    \n",
        "    # Calculate g(r) with correct normalization\n",
        "    rho = N / L**3  # number density\n",
        "    dr = r_edges[1:] - r_edges[:-1]  # bin widths\n",
        "    \n",
        "    # Volume of spherical shell\n",
        "    shell_volumes = 4 * np.pi * r_centers**2 * dr\n",
        "    \n",
        "    # For each particle, expected number of neighbors in shell = rho * shell_volume\n",
        "    # Total expected pairs in shell = N * rho * shell_volume / 2 \n",
        "    # (divide by 2 because we count each pair once)\n",
        "    expected_pairs = N * rho * shell_volumes / 2\n",
        "    \n",
        "    # g(r) = actual_pairs / expected_pairs\n",
        "    g_r = hist / expected_pairs\n",
        "    \n",
        "    return r_centers, g_r\n",
        "\n",
        "r, g = radial_distr(positions, L)\n",
        "plt.plot(r, g, 'b-', drawstyle=\"steps-mid\")\n",
        "plt.axhline(y=1, color='r', linestyle='--', alpha=0.7, label='Ideal gas (g(r)=1)')\n",
        "plt.xlabel(\"r\")\n",
        "plt.ylabel(\"g(r)\")\n",
        "plt.gca().set(xlim=(0, L/2),ylim=(0,2))\n",
        "plt.legend()\n",
        "plt.show()\n",
        "```\n",
        "\n",
        "We can compare this with arrangements of hard spheres\n",
        "```{pyodide}\n",
        "#| caption: \"Radial distribution function for a hard sphere configuration [press ctrl/cmd [ENTER] to run]\"\n",
        "# now try with hard spheres, using a custom libarry you will find in the course pages\n",
        "from src import hardspheres\n",
        "\n",
        "sigma = 1.0\n",
        "L = 5.*sigma #take a small value\n",
        "phi = 0.2 # packing fraction\n",
        "N = int(phi/(np.pi/6*sigma**3)*L**3)\n",
        "\n",
        "#  we run Monte-Carlo simulations of hard-spheres on the fly \n",
        "freq = 5\n",
        "nsteps = 100*N\n",
        "trajectory, acceptance = hardspheres.Monte_Carlo_traj(N,L, sigma, nsteps,freq)\n",
        "gs = []\n",
        "for positions in trajectory:\n",
        "    _r, _g = radial_distr(positions, L)\n",
        "    gs.append(_g)\n",
        "plt.plot(r, np.mean(gs,axis=0), 'b-', label=rf\"Hard spheres, rf$\\phi={phi}$\")\n",
        "plt.set(xlabel=\"r\", ylabel=\"g(r)\", ylim= (0,2))\n",
        "plt.legend()\n",
        "plt.show()\n",
        "\n",
        "```\n",
        "\n",
        "The radial distribution function is the central object of much of **liquid state theory**, which aims to predict the shape of the correlation functions (such as $g(r)$) from the sole knowledge of the interaction potential between the elementary particles (see @santos2016concise for a gentle introduction to the topic). In particular, one can imagine the correlations between two particles $1$ and $2$ in a fluid to have two possible origins\n",
        "\n",
        "- a **direct** correlation between the two particles, mediated by direct interactions (e.g. collisions) between 1 and 2. \n",
        "- an **indirect correlation**, mediated by other particle sin the fluid \n",
        "\n",
        "The $g(r)$ contains both direct and indirect correlations. We can assume that a suitable function $c(r)$ exists to express the direct correlations. In such case, for twobody interactions, we cna write a hierarchy of equations via a central result of liquid state theory, the **Ornestein-Zernicke** (OZ) equation\n",
        "\n",
        "$$\n",
        "h\\left(r_{12}\\right)=c\\left(r_{12}\\right)+\\rho \\int c\\left(r_{13}\\right) h\\left(r_{32}\\right) d \\mathbf{r}_3\n",
        "$${#eq-oz}\n",
        "\n",
        "where we defined the total correlation function as $h(r)=g(r)-1$. The OZ equation is an integral equation. In Fourier space (assuming the isotropicity of a fluid) it becomes an algebraic equation\n",
        "$$\n",
        "\\tilde{h}(k)=\\frac{\\tilde{c}(k)}{1-\\rho \\tilde{c}(k)}\n",
        "$$\n",
        "Since both $h(r)$ and $c(r)$ an additional relationship is known called a **closure**. These constructed through phsyical arguments. A common one is the so-caled Percus-Yevick closure\n",
        "\n",
        "$$\n",
        "c(r)=[1+h(r)]\\left[1-e^{\\beta U(r)}\\right]\n",
        "$$\n",
        "where the pairwise interaction enters explicitly.\n",
        "\n",
        "Solving the OZ equation with the Percus-Yevick closure produces realistic radial distribution functions in a wide range of packing fractions for hard spheres."
      ],
      "id": "92e03c6f"
    },
    {
      "cell_type": "code",
      "metadata": {},
      "source": [
        "#| echo: false\n",
        "import matplotlib.pyplot as plt\n",
        "import numpy as np\n",
        "from numpy import pi\n",
        "\n",
        "# Percus-Yevick Terms  (see for instance D. Henderson Condensed Matter Physics 2009, Vol. 12, No 2, pp. 127-135)\n",
        "def c0(eta):\n",
        "    return -(1.+2.*eta)**2/(1.-eta)**4\n",
        "def c1(eta):\n",
        "    return 6.*eta*(1.+eta*0.5)**2/(1.-eta)**4\n",
        "def c3(eta):\n",
        "    return eta*0.5*c0(eta)\n",
        "def cc(r,eta):\n",
        "    if r>1:\n",
        "        return 0\n",
        "    else:\n",
        "        return c0(eta)+c1(eta)*r+c3(eta)*r**3\n",
        "# Spherical Fourier Transforms (using the liquid isotropicity)\n",
        "def spherical_FT(f,k,r,dr):\n",
        "    ft=np.zeros(len(k))\n",
        "    for i in range(len(k)):\n",
        "        ft[i]=4.*pi*np.sum(r*np.sin(k[i]*r)*f*dr)/k[i]\n",
        "    return ft\n",
        "\n",
        "def inverse_spherical_FT(ff,k,r,dk):\n",
        "    ift=np.zeros(len(r))\n",
        "    for i in range(len(r)):\n",
        "        ift[i]=np.sum(k*np.sin(k*r[i])*ff*dk)/r[i]/(2*pi**2)\n",
        "    return ift\n",
        "\n",
        "def PercusYevickHS(phi):\n",
        "    # number density\n",
        "    rho=6./pi*phi\n",
        "    # getting the direct correlation function c(r) from the analytic Percus-Yevick solution\n",
        "    # vectorizing the function\n",
        "    c=np.vectorize(cc)\n",
        "    # space discretization\n",
        "    dr=0.001\n",
        "    r=np.arange(1,5*1024+1,1 )*dr\n",
        "    # reciprocal space discretization (highest available frequency)\n",
        "    dk=1/r[-1]\n",
        "    k=np.arange(1,1024+1,1 )*dk\n",
        "    # direct correlation function c(r)\n",
        "    c_direct=c(r,phi)\n",
        "    # getting the Fourier transform\n",
        "    ft_c_direct=spherical_FT(c_direct, k,r,dr)\n",
        "    # using the Ornstein-Zernike equation, getting the structure factor\n",
        "    ft_h=ft_c_direct/(1.-rho*ft_c_direct)\n",
        "    # inverse Fourier transform\n",
        "    h=inverse_spherical_FT(ft_h, k,r,dk)\n",
        "    # print h\n",
        "    # # radial distribution function\n",
        "    gg=h+1\n",
        "    # clean the r<1 region\n",
        "    g=np.zeros(len(gg))\n",
        "    g[r>=1]=gg[r>=1]\n",
        "    plt.plot(r,g, label=f\"$\\phi = ${phi}\")\n",
        "\n",
        "    # plots\n",
        "\n",
        "# call the function\n",
        "PercusYevickHS(0.2)\n",
        "PercusYevickHS(0.3)\n",
        "PercusYevickHS(0.4)\n",
        "PercusYevickHS(0.5)\n",
        "plt.title(\"Hard-spheres radial distribution function from liquid state theory\")\n",
        "plt.ylabel(\"g(r)\")\n",
        "plt.xlabel(r\"$r / \\sigma$\")\n",
        "plt.legend(frameon=False)\n",
        "import matplotlib\n",
        "\n",
        "# print(matplotlib.matplotlib_fname())\n",
        "plt.show()"
      ],
      "id": "8855b38d",
      "execution_count": null,
      "outputs": []
    },
    {
      "cell_type": "markdown",
      "metadata": {},
      "source": [
        "### Dynamics: single vs collective displacements\n",
        "\n",
        "We have seen [earlier](../phase-transitions/Brownian-and-Langevin-dynamics.qmd) that if we are given a number of particles evolving microscopically according to the Langevin equation of drag $\\gamma$ and zero-mean noise $\\eta$\n",
        "\n",
        "$$\n",
        "m \\frac{d \\vec{v}}{d t}=-\\gamma\\vec{v}+\\vec{\\eta}(t)\n",
        "$$\n",
        "\n",
        "then an *ensemble* of independent particles will follow the **diffusion equation**:\n",
        "\n",
        "$$\\frac{\\partial \\rho(\\mathbf{r}, t)}{\\partial t} = D \\nabla^2 \\rho(\\mathbf{r}, t) $$\n",
        "\n",
        "where $\\rho(\\mathbf{r},t)$ is the probability of finding a particle at position $\\mathbf{r}$ at time $t$ with diffusivity $D$. The diffusivity $D$ is related to the microscopic Langevin equation parameters via the fluctuation-dissipation relation (or Einstein relation)\n",
        "$$\n",
        "D = \\frac{k_B T}{\\gamma}\n",
        "$$\n",
        "where $k_B$ is Boltzmann's constant, $T$ is temperature, and $\\gamma$ is the friction (drag) coefficient.\n",
        "\n",
        "It is easy to show (see below) that in 1 dimension the general solution is\n",
        "\n",
        "$$\n",
        "\\rho(x, t) = \\frac{1}{\\sqrt{4\\pi D t}} \\exp\\left(-\\frac{x^2}{4Dt}\\right)\n",
        "$$\n",
        "\n",
        "\n",
        "::: {.callout-note collapse=\"true\"}\n",
        "# Solution of the diffusion equation using Laplace transform\n",
        "\n",
        "The 1D diffusion equation is:\n",
        "$$\n",
        "\\frac{\\partial \\rho(x, t)}{\\partial t} = D \\frac{\\partial^2 \\rho(x, t)}{\\partial x^2}\n",
        "$$\n",
        "\n",
        "Suppose the initial condition is a delta function at the origin:\n",
        "$$\n",
        "\\rho(x, 0) = \\delta(x)\n",
        "$$\n",
        "\n",
        "Take the Laplace transform in time:\n",
        "$$\n",
        "\\tilde{\\rho}(x, s) = \\int_0^\\infty \\rho(x, t) e^{-st} dt\n",
        "$$\n",
        "\n",
        "The Laplace transform of the time derivative:\n",
        "$$\n",
        "\\mathcal{L}\\left[\\frac{\\partial n}{\\partial t}\\right] = s\\tilde{\\rho}(x, s) - \\rho(x, 0)\n",
        "$$\n",
        "\n",
        "So the transformed equation is:\n",
        "$$\n",
        "s\\tilde{\\rho}(x, s) - \\delta(x) = D \\frac{\\partial^2 \\tilde{\\rho}(x, s)}{\\partial x^2}\n",
        "$$\n",
        "\n",
        "Rearrange:\n",
        "$$\n",
        "D \\frac{\\partial^2 \\tilde{\\rho}}{\\partial x^2} - s\\tilde{\\rho} = -\\delta(x)\n",
        "$$\n",
        "\n",
        "For $x \\neq 0$, the homogeneous equation:\n",
        "$$\n",
        "D \\frac{\\partial^2 \\tilde{\\rho}}{\\partial x^2} - s\\tilde{\\rho} = 0\n",
        "$$\n",
        "\n",
        "General solution:\n",
        "$$\n",
        "\\tilde{\\rho}(x, s) = A e^{-\\lambda |x|}, \\quad \\lambda = \\sqrt{\\frac{s}{D}}\n",
        "$$\n",
        "\n",
        "The delta function at $x=0$ gives a discontinuity in the derivative:\n",
        "$$\n",
        "\\left.\\frac{\\partial \\tilde{\\rho}}{\\partial x}\\right|_{x=0^+} - \\left.\\frac{\\partial \\tilde{\\rho}}{\\partial x}\\right|_{x=0^-} = -\\frac{1}{D}\n",
        "$$\n",
        "\n",
        "Compute derivatives:\n",
        "$$\n",
        "\\frac{\\partial \\tilde{\\rho}}{\\partial x} = -A \\lambda \\, \\text{sgn}(x) e^{-\\lambda |x|}\n",
        "$$\n",
        "\n",
        "So at $x=0^+$: $-A\\lambda$, at $x=0^-$: $A\\lambda$. The jump is $-2A\\lambda$.\n",
        "\n",
        "Set equal to $-1/D$:\n",
        "$$\n",
        "-2A\\lambda = -\\frac{1}{D} \\implies A = \\frac{1}{2D\\lambda}\n",
        "$$\n",
        "\n",
        "So:\n",
        "$$\n",
        "\\tilde{\\rho}(x, s) = \\frac{1}{2D\\lambda} e^{-\\lambda |x|} = \\frac{1}{2\\sqrt{Ds}} e^{-|x|\\sqrt{\\frac{s}{D}}}\n",
        "$$\n",
        "\n",
        "Invert the Laplace transform (using tables or convolution theorem):\n",
        "$$\n",
        "\\rho(x, t) = \\frac{1}{\\sqrt{4\\pi D t}} \\exp\\left(-\\frac{x^2}{4Dt}\\right)\n",
        "$$\n",
        "\n",
        "This is the fundamental solution (Green's function) of the diffusion equation.\n",
        ":::\n",
        "\n",
        "The diffusion equation can also be read as a simple consequence of two requirements:\n",
        "\n",
        "- continuity of the distribution of mass (no mass is lost during the transport), as expressed in the **continuity equation**\n",
        "$$\n",
        "\\frac{\\partial \\rho(\\mathbf{r}, t)}{\\partial t} + \\nabla \\cdot \\mathbf{J}(\\mathbf{r}, t) = 0\n",
        "$$\n",
        "where the divergence $\\nabla \\cdot \\mathbf{J}(\\mathbf{r}, t)$ represents the net outflow of particles from a given region due to the flux $\\mathbf{J}$.\n",
        "\n",
        "- the flux of particles is assumed to be proportional to the gradient in the density (or concnetration of the particles). This can be taken as an empirical assumption, a reasonable approximation (i.e. a perturbative approach) or a consequence of underlying Brownian dynamics. It is known as Fick's law:\n",
        "\n",
        "$$\n",
        "\\mathbf{J}(\\mathbf{r}, t) = -D \\nabla \\rho(\\mathbf{r}, t)\n",
        "$$\n",
        "\n",
        "The diffusivity constant $D$ is therefore central for the diffusion. It is possible to link the microscopic motion of the particles to the collective behaviour of the density distribution $\\rho(x,t)$ by exploting the connection provided bt the **mean squared displacement**, which is simply the variance of the distributione $\\rho(x,t)$ at time $t$.\n",
        "\n",
        "As discussed earlier, in $d$ dimensions this is equal to \n",
        "$$\\langle r(t)^2\\rangle-\\langle r(t)\\rangle^2 = 2d D t$$\n",
        "\n",
        "Hence, measuring the average squared displacements is sufficient to recover the diffusivity and to reconstruct the distribution.\n",
        "\n",
        "#### Diffusion and interactions\n",
        "\n",
        "We have up to now considered the dilute (or non-nteracting) limit, where collisions between the colloids are ignored. Let's now consider instead simple colloids (again, hard spheres) and their dynamics.\n",
        "\n",
        "We are interested in the mean squared displacement $\\left\\langle r^{2}(t)\\right\\rangle$ as a function of time for different volume fractions. At low volume fractions, the particles undergo Brownian motion (random-walk diffusion) due to collisions with liquid molecules. The mean squared displacement (in three dimensions) is $$\\left\\langle\\underline{r}^{2}(t)\\right\\rangle=6 D_{0} t$$ \n",
        "where the meaning of the subscript 0 will be apparent shortly.\n",
        "\n",
        " For sufficiently dense hard spheres (e.g. above $\\phi \\sim 0.3$), however, different regimes are observed. At short times the particles diffuse with the short time (self) diffusion constant $D_{s}$. This is determined from the short time limit and is smaller than the $D_{0}$ measured for $\\phi \\rightarrow 0$. The motion of the particles (self diffusion) is still driven by collisions with the liquid molecules, but in addition the interactions between particles become significant. \n",
        " \n",
        " While the particles are diffusing in their cages formed by their neighbours, the hydrodynamic interaction with the neighbours, transmitted through flows in the liquid, causes slowing down relative to the free diffusion at low concentrations. At intermediate times the particles encounter the neighbours and the interactions slow the motion down. To make further progress, the particle has to break out of the cage formed by its neighbours. Now the particles experience a further interaction, direct interactions (hard-sphere interactions), in addition to the hydrodynamic interactions. The long-time and long-ranged movement is also diffusive, i.e. we still have $$\\langle r^{2}(t)\\rangle \\propto t$$ when the particles undergo large-scale random-walk diffusion through many cages. \n",
        " \n",
        " However, the motion is further slowed and a smaller diffusion constant relative to the motion in the short time limit is observed, the long time (self) diffusion constant $D_{L}$. \n"
      ],
      "id": "0e8efe1c"
    },
    {
      "cell_type": "code",
      "metadata": {},
      "source": [
        "#| echo: false\n",
        "\n",
        "import numpy as np\n",
        "import matplotlib.pyplot as plt\n",
        "\n",
        "t = np.linspace(0, 10, 200)\n",
        "D0 = 2\n",
        "Ds = 1\n",
        "DL = 0.1\n",
        "msd1 = D0 * t\n",
        "turning_point = 2\n",
        "# Use a smooth transition at the turning point using a sigmoid function\n",
        "plt.figure(figsize=(8,5))\n",
        "def smooth_transition(t, turning_point, width=0.2):\n",
        "    # width controls how sharp the transition is\n",
        "    s = 1 / (1 + np.exp(-(t - turning_point) / width))\n",
        "    # Ensure continuity and avoid overshoot by matching slopes at the transition\n",
        "    msd_before = Ds * t\n",
        "    msd_after = Ds * turning_point + DL * (t - turning_point)\n",
        "    return msd_before * (1 - s) + msd_after * s\n",
        "\n",
        "msd2 = smooth_transition(t, turning_point)\n",
        "plt.plot(t, msd1, label=\"Dilute\")\n",
        "plt.plot(t, msd2, label=\"Dense\")\n",
        "plt.xlabel(\"time \")\n",
        "plt.ylabel(\"Mean squared displacement \")\n",
        "plt.ylim(0,10)\n",
        "plt.xlim(0,10)\n",
        "plt.legend(frameon=False)\n",
        "plt.gca().text(3,9,\"$6D_0 t$\",fontsize=\"x-large\")\n",
        "plt.gca().text(1.4,1,\"$6D_s t$\",fontsize=\"x-large\")\n",
        "plt.gca().text(8.5,3,\"$6D_L t$\",fontsize=\"x-large\")\n",
        "plt.gca().set_xticks([])\n",
        "plt.gca().set_yticks([])\n",
        "plt.show()\n"
      ],
      "id": "e6a736aa",
      "execution_count": null,
      "outputs": []
    },
    {
      "cell_type": "markdown",
      "metadata": {},
      "source": [
        " The slowing down due to collisions eventually dominates the ohysics of hard spheres at high densities. This is more broadly true also for generic dense colloidal suspensions, where the short range interactions dominate on other mechanisms of motion (including the hydrodynamics). Eventually, for very dense packings one observes the emergence of a new physical regime where relaxation becomes anomalous and non-diffusive: this is the glassy regime, which we will revisit in a following chapter.\n",
        "\n",
        "\n",
        " <!-- short time: $<r^{2}(t)>=6 D_{S} t$ short-time self diff. coeff. $D_{S}<D_{0}$ purely because of hydrodyn. interactions theoretical predictions exist intermediate time: some theory long time: $<r^{2}(t)>=6 D_{L} t$ long-time self diff. coeff. $D_{L}<D_{S}\\left(<D_{0}\\right)$ because of hydrodyn. and direct interactions theory very complicated, but some predictions exist.  -->\n",
        "\n",
        "### Stokes-Einstein relation\n",
        "\n",
        "Suppose that the particles are subjected to an external force F in the x direction, e.g. gravity. In thermal equilibrium the Maxwell-Boltzmann distribution is valid, i.e. the particle density $n(x)$ is given by\n",
        "\n",
        "$$\n",
        "n(x)=n_{0} \\exp \\left(-U(x) / k_{B} T\\right)=n_{0} \\exp \\left(-F x / k_{B} T\\right)\n",
        "$$\n",
        "\n",
        "where we assumed a constant force $F$ in the last equation. In the case of gravity $F=m_{B} g$ with $m_{B}$ the buoyant mass. $n(x)$ results from the balance between the motion of the particles due to the external force setting up a concentration gradient, and the resultant diffusion given by Fick's law. \n",
        "\n",
        "```{ojs}\n",
        "// | echo: false\n",
        "{\n",
        "  const width = 600;\n",
        "const height = 400;\n",
        "const numCircles = 300;\n",
        "\n",
        "let temperature = 300;    // Arbitrary scale\n",
        "let viscosity = 0.02;     // Arbitrary scale\n",
        "const particleRadius = 5; // pixels\n",
        "let timeStep = 1;\n",
        "\n",
        "const kB = 1; // reduced units\n",
        "let gravityFactor = 0.1;\n",
        "let gravity = 10 * gravityFactor;\n",
        "\n",
        "// Compute damping as velocity decay per timestep (Langevin friction)\n",
        "function computeDamping(viscosity, radius, dt) {\n",
        "  const gamma = 6 * Math.PI * viscosity * radius; // friction coeff\n",
        "  return Math.exp(-gamma * dt);\n",
        "}\n",
        "\n",
        "let damping = computeDamping(viscosity, particleRadius, timeStep);\n",
        "\n",
        "// Create SVG\n",
        "const svg = d3.create(\"svg\")\n",
        "  .attr(\"width\", width)\n",
        "  .attr(\"height\", height)\n",
        "  .style(\"border\", \"1px solid #ccc\")\n",
        "  .style(\"background\", \"#f9f9f9\");\n",
        "\n",
        "// Initialize circles\n",
        "const circles = Array.from({ length: numCircles }, (_, i) => ({\n",
        "  id: i,\n",
        "  x: Math.random() * width,\n",
        "  y: Math.random() * height * 0.3,\n",
        "  vx: (Math.random() - 0.5) * 2,\n",
        "  vy: (Math.random() - 0.5) * 2,\n",
        "  radius: particleRadius,\n",
        "  color: d3.interpolateYlOrBr(Math.random() * 0.5 + 0.25)\n",
        "}));\n",
        "\n",
        "// Create circles in SVG\n",
        "const circleElements = svg.selectAll(\"circle\")\n",
        "  .data(circles)\n",
        "  .enter()\n",
        "  .append(\"circle\")\n",
        "  .attr(\"r\", d => d.radius)\n",
        "  .attr(\"fill\", d => d.color)\n",
        "  .attr(\"opacity\", 0.8)\n",
        "  .attr(\"stroke\", \"#333\")\n",
        "  .attr(\"stroke-width\", 1);\n",
        "\n",
        "// Collision detection & response\n",
        "function handleCollisions() {\n",
        "  for (let i = 0; i < circles.length; i++) {\n",
        "    for (let j = i + 1; j < circles.length; j++) {\n",
        "      const c1 = circles[i];\n",
        "      const c2 = circles[j];\n",
        "      const dx = c2.x - c1.x;\n",
        "      const dy = c2.y - c1.y;\n",
        "      const dist = Math.hypot(dx, dy);\n",
        "      const minDist = c1.radius + c2.radius;\n",
        "\n",
        "      if (dist < minDist && dist > 0) {\n",
        "        const overlap = minDist - dist;\n",
        "        const nx = dx / dist;\n",
        "        const ny = dy / dist;\n",
        "\n",
        "        c1.x -= nx * overlap / 2;\n",
        "        c1.y -= ny * overlap / 2;\n",
        "        c2.x += nx * overlap / 2;\n",
        "        c2.y += ny * overlap / 2;\n",
        "\n",
        "        const dvx = c2.vx - c1.vx;\n",
        "        const dvy = c2.vy - c1.vy;\n",
        "        const vn = dvx * nx + dvy * ny;\n",
        "\n",
        "        if (vn > 0) continue;\n",
        "\n",
        "        const restitution = 1.0;\n",
        "        const impulse = (-(1 + restitution) * vn) / 2;\n",
        "\n",
        "        c1.vx -= impulse * nx;\n",
        "        c1.vy -= impulse * ny;\n",
        "        c2.vx += impulse * nx;\n",
        "        c2.vy += impulse * ny;\n",
        "      }\n",
        "    }\n",
        "  }\n",
        "}\n",
        "\n",
        "// Update damping when viscosity or timestep changes\n",
        "function updateDamping() {\n",
        "  damping = computeDamping(viscosity, particleRadius, timeStep);\n",
        "}\n",
        "\n",
        "// Animate function\n",
        "function animate() {\n",
        "  const diffusion = (kB * temperature) / (6 * Math.PI * viscosity * particleRadius);\n",
        "\n",
        "  circles.forEach(c => {\n",
        "    // Apply gravity\n",
        "    c.vy += gravity * timeStep;\n",
        "\n",
        "    // Diffusion random kick scaled by sqrt(2*D/dt)\n",
        "    const diffusionForce = Math.sqrt(2 * diffusion / timeStep);\n",
        "    c.vx += (Math.random() - 0.5) * diffusionForce;\n",
        "    c.vy += (Math.random() - 0.5) * diffusionForce;\n",
        "\n",
        "    // Apply damping\n",
        "    c.vx *= damping;\n",
        "    c.vy *= damping;\n",
        "\n",
        "    // Update position\n",
        "    c.x += c.vx * timeStep;\n",
        "    c.y += c.vy * timeStep;\n",
        "\n",
        "    // Boundary collision\n",
        "    if (c.x - c.radius < 0) {\n",
        "      c.x = c.radius;\n",
        "      c.vx *= -1;\n",
        "    }\n",
        "    if (c.x + c.radius > width) {\n",
        "      c.x = width - c.radius;\n",
        "      c.vx *= -1;\n",
        "    }\n",
        "    if (c.y - c.radius < 0) {\n",
        "      c.y = c.radius;\n",
        "      c.vy *= -1;\n",
        "    }\n",
        "    if (c.y + c.radius > height) {\n",
        "      c.y = height - c.radius;\n",
        "      c.vy *= -1;\n",
        "    }\n",
        "  });\n",
        "\n",
        "  handleCollisions();\n",
        "\n",
        "  circleElements\n",
        "    .attr(\"cx\", d => d.x)\n",
        "    .attr(\"cy\", d => d.y);\n",
        "\n",
        "  diffusionDisplay.text(`Diffusion: ${diffusion.toFixed(4)}`);\n",
        "}\n",
        "\n",
        "// Start timer\n",
        "const timer = d3.timer(animate);\n",
        "\n",
        "// Controls container\n",
        "const controls = d3.create(\"div\")\n",
        "  .style(\"margin-top\", \"10px\")\n",
        "  .style(\"padding\", \"10px\")\n",
        "  .style(\"background\", \"#f0f0f0\")\n",
        "  .style(\"border-radius\", \"8px\")\n",
        "  .style(\"width\", `${width}px`);\n",
        "\n",
        "// Slider factory\n",
        "function createSlider(labelText, min, max, initial, step, onChange) {\n",
        "  const container = controls.append(\"div\")\n",
        "    .style(\"margin-bottom\", \"10px\")\n",
        "    .style(\"display\", \"flex\")\n",
        "    .style(\"align-items\", \"center\")\n",
        "    .style(\"gap\", \"10px\");\n",
        "\n",
        "  container.append(\"label\")\n",
        "    .text(labelText)\n",
        "    .style(\"min-width\", \"120px\")\n",
        "    .style(\"font-weight\", \"bold\");\n",
        "\n",
        "  const slider = container.append(\"input\")\n",
        "    .attr(\"type\", \"range\")\n",
        "    .attr(\"min\", min)\n",
        "    .attr(\"max\", max)\n",
        "    .attr(\"step\", step)\n",
        "    .attr(\"value\", initial)\n",
        "    .style(\"flex\", \"1\");\n",
        "\n",
        "  const valueDisplay = container.append(\"span\")\n",
        "    .text(initial.toFixed(step < 1 ? 4 : 0))\n",
        "    .style(\"width\", \"50px\")\n",
        "    .style(\"text-align\", \"right\")\n",
        "    .style(\"font-family\", \"monospace\");\n",
        "\n",
        "  slider.on(\"input\", function () {\n",
        "    const val = +this.value;\n",
        "    onChange(val);\n",
        "    valueDisplay.text(val.toFixed(step < 1 ? 4 : 0));\n",
        "  });\n",
        "\n",
        "  return slider;\n",
        "}\n",
        "\n",
        "// Create sliders\n",
        "createSlider(\"Gravity\", -100, 100, gravity / gravityFactor, 10, v => gravity = v * gravityFactor);\n",
        "\n",
        "createSlider(\"Temperature\", 0, 1000, temperature, 10, v => temperature = v);\n",
        "\n",
        "createSlider(\"Viscosity\", 0.001, 0.1, viscosity, 0.001, v => {\n",
        "  viscosity = v;\n",
        "  updateDamping();\n",
        "});\n",
        "\n",
        "// createSlider(\"Time Step\", 0.1, 5, timeStep, 0.1, v => {\n",
        "//   timeStep = v;\n",
        "//   updateDamping();\n",
        "// });\n",
        "\n",
        "// Diffusion display\n",
        "const diffusionDisplay = controls.append(\"div\")\n",
        "  .style(\"margin-top\", \"10px\")\n",
        "  .style(\"font-family\", \"monospace\")\n",
        "  .style(\"font-weight\", \"bold\")\n",
        "  .text(\"\");\n",
        "\n",
        "// Reset button\n",
        "controls.append(\"button\")\n",
        "  .text(\"Reset Positions\")\n",
        "  .style(\"margin-top\", \"10px\")\n",
        "  .style(\"padding\", \"6px 12px\")\n",
        "  .on(\"click\", () => {\n",
        "    circles.forEach(c => {\n",
        "      c.x = Math.random() * width;\n",
        "      c.y = Math.random() * height * 0.3;\n",
        "      c.vx = (Math.random() - 0.5) * 2;\n",
        "      c.vy = (Math.random() - 0.5) * 2;\n",
        "    });\n",
        "  });\n",
        "\n",
        "// Start/Stop toggle\n",
        "const startStopBtn = controls.append(\"button\")\n",
        "  .text(\"Stop\")\n",
        "  .style(\"margin-left\", \"10px\")\n",
        "  .style(\"padding\", \"6px 12px\")\n",
        "  .on(\"click\", function () {\n",
        "    if (timer._call) {\n",
        "      timer.stop();\n",
        "      this.textContent = \"Start\";\n",
        "    } else {\n",
        "      timer.restart(animate);\n",
        "      this.textContent = \"Stop\";\n",
        "    }\n",
        "  });\n",
        "\n",
        "// Container div\n",
        "const container = d3.create(\"div\");\n",
        "container.node().appendChild(svg.node());\n",
        "container.node().appendChild(controls.node());\n",
        "\n",
        "return container.node();\n",
        "}\n",
        "```\n",
        "\n",
        "<!-- ![](https://cdn.mathpix.com/cropped/2025_01_27_a9af280ad9752fe3d0c0g-13.jpg?height=291&width=619&top_left_y=1597&top_left_x=466) -->\n",
        "\n",
        "In the case of gravity, this leads to a sedimentation equilibrium. (a) Flux due to external force, $J_{F}$\n",
        "\n",
        "The velocity of a particle under an applied force $F$ in a viscous fluid can be written as $v=$ $F / \\xi$ which defines the friction coefficient $\\xi$. Hence\n",
        "\n",
        "$$\n",
        "J_{F}=n(x) v=\\frac{n(x) F}{\\xi}\n",
        "$$\n",
        "\n",
        "(b) Diffusive flux, $J_{D}$ $J_{D}$ is given by Fick's Law (see above):\n",
        "\n",
        "$$\n",
        "J_{D}(x)=-D \\frac{\\partial n(x)}{\\partial x}\n",
        "$$\n",
        "\n",
        "Equating the two fluxes $J_{F}=J_{D}$ we get\n",
        "\n",
        "$$\n",
        "\\frac{n(x) F}{\\xi}=-D \\frac{\\partial n(x)}{d x}=+D \\frac{F}{k_{B} T} n(x)\n",
        "$$\n",
        "\n",
        "The second equation is obtained by differentiating the Maxwell-Boltzmann distribution. This gives the relation between the diffusion and friction coefficients:\n",
        "\n",
        "$$\n",
        "D=\\frac{k_{B} T}{\\xi}=\\frac{k_{B} T}{6 \\pi \\eta R}\n",
        "$$\n",
        "\n",
        "The last equation applies to a spherical particle of radius $R$ in a fluid of viscosity $\\eta$, for which Stokes's Law gives $\\xi=6 \\pi \\eta R$ (which applies only at low Reynold's number, $\\rho R v / \\eta$ $\\ll 1$ ) resulting in the Stokes-Einstein (and Sutherland) relation.\n",
        "\n",
        "-   The Stokes-Einstein relation is a very deep result. It relates equilibrium fluctuations in a system to the energy dissipation when the system is driven off equilibrium. Here, the fluctuations in the fluid give rise to the diffusive motion of the suspended particle and $D$ is therefore the 'fluctuation' part. A sheared fluid will dissipate energy because of its finite viscosity and thus $\\eta$ represents the dissipative part.\n",
        "-   More generally, Brownian motion sets a natural limit to the precision of physical measurements. Example from the [Feynman Lectures](https://www.feynmanlectures.caltech.edu/I_41.html):\n",
        "\n",
        "    > A mirror suspended on a torsion fibre reflects a spot of light onto a scale. The spot will jiggle due to the random impact of air molecules and the random motion of atoms in the quartz fibre. To reduce the jiggle, the apparatus has to be cooled. The relation between fluctuation and dissipation tells us where to cool. 'This depends upon where \\[the mirror\\] is getting its 'kicks' from. If it is through the fibre, we cool it ... if the mirror is surrounded by a gas and is getting hit mostly by collisions in the gas, it is better to cool the gas. As a matter of fact, if we know where the damping of the oscillations comes from, it turns out that that is always the source of the fluctuations. (Adapted from Feynman, Chapter 41)\n",
        "\n",
        "\n",
        "\n",
        "::: {.callout-important}\n",
        "\n",
        "# Check your understanding\n",
        "\n",
        "- Colloids are mixtures with dispersed particles (1 nm – 1 μm) that remain suspended due to Brownian motion.\n",
        "- Stability of colloids depends on the balance between attractive (van der Waals) and repulsive (double layer) interactions.\n",
        "- The DLVO theory combines van der Waals attraction and double layer repulsion to explain colloidal stability and aggregation.\n",
        "- Entropic effects (e.g., depletion interactions) can induce effective attractions even in purely repulsive systems.\n",
        "- Hard-sphere colloids are a fundamental model: their phase behavior is controlled by packing fraction, leading to fluid, crystalline, and metastable (jammed) states.\n",
        "- The radial distribution function $g(r)$ characterizes spatial correlations and structure in colloidal systems.\n",
        "- Dynamics of colloids are governed by Brownian motion, with diffusion slowed at higher densities due to interactions.\n",
        "- The Stokes-Einstein relation links diffusion to temperature, viscosity, and particle size.\n",
        "- Entropy can drive ordering (e.g., crystallization of hard spheres), showing that entropy is not always associated with disorder.\n",
        "- Colloidal systems serve as accessible models for studying fundamental concepts in soft matter and statistical mechanics.\n",
        "\n",
        ":::\n",
        "\n",
        "\n",
        "<!-- ![Feynamnn schematic of a sensitive light-beam galvanometer.](https://www.feynmanlectures.caltech.edu/img/FLP_I/f41-01/f41-01_tc_big_a.svg) -->\n",
        "\n",
        "\n",
        "<!-- ### Particle dynamics\n",
        "\n",
        "#### Hard-spheres\n",
        "\n",
        "We are interested in the mean-square displacement $\\left\\langle\\underline{r}^{2}(t)\\right\\rangle$ as a function of time for different volume fractions. At low volume fractions, the particles undergo Brownian motion (random-walk diffusion) due to collisions with liquid molecules. The meansquare displacement $\\left\\langle\\underline{r}^{2}(t)\\right\\rangle=6 D_{0} t$ as already seen earlier. Above $\\phi \\sim 0.3$, however, different regimes are observed. At short times the particles diffuse with the short time (self) diffusion constant $D_{s}$. This is determined from the short time limit and is smaller than the $D_{0}$ measured for $\\phi \\rightarrow 0$. The motion of the particles (self diffusion) is still driven by collisions with the liquid molecules, but in addition the interactions between particles become significant. While the particles are diffusing in their cages formed by their neighbours, the hydrodynamic interaction ![](https://cdn.mathpix.com/cropped/2025_01_27_a9af280ad9752fe3d0c0g-18.jpg?height=391&width=432&top_left_y=368&top_left_x=1351) with the neighbours, transmitted through flows in the liquid, causes slowing down relative to the free diffusion at low concentrations. At intermediate times the particles encounter the neighbours and the interactions slow the motion down. To make further progress, the particle has to break out of the cage formed by its neighbours. Now the particles experience a further interaction, direct interactions (hard-sphere interactions), in addition to the hydrodynamic interactions. The long-time and long-ranged movement is also diffusive, i.e. we still have $\\left\\langle\\underline{r}^{2}(t)>\\propto t\\right.$, when the particles undergo large-scale random-walk diffusion through many cages. However, the motion is further slowed and a smaller diffusion constant relative to the motion in the short time limit is observed, the long time (self) diffusion constant $D_{L}$. ![](https://cdn.mathpix.com/cropped/2025_01_27_a9af280ad9752fe3d0c0g-19.jpg?height=777&width=1086&top_left_y=868&top_left_x=539) short time: $<r^{2}(t)>=6 D_{S} t$ short-time self diff. coeff. $D_{S}<D_{0}$ purely because of hydrodyn. interactions theoretical predictions exist intermediate time: some theory long time: $<r^{2}(t)>=6 D_{L} t$ long-time self diff. coeff. $D_{L}<D_{S}\\left(<D_{0}\\right)$ because of hydrodyn. and direct interactions theory very complicated, but some predictions exist. -->\n",
        "\n",
        "## References {.unnumbered}"
      ],
      "id": "467f7380"
    }
  ],
  "metadata": {
    "kernelspec": {
      "name": "python3",
      "language": "python",
      "display_name": "Python 3 (ipykernel)",
      "path": "/Users/phxnw/Library/Python/3.9/share/jupyter/kernels/python3"
    }
  },
  "nbformat": 4,
  "nbformat_minor": 5
}